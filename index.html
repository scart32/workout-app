<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Prevent zoom -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Workout App</title>

  <style>
    :root{
      color-scheme: dark;

      /* Elite performance lab palette */
      --bg0:#070812;
      --bg1:#0b0f22;

      --text:#f3f6ff;
      --muted:#a8b0c6;
      --muted2: rgba(168,176,198,.72);

      --accent:#7c5cff;   /* violet */
      --accent2:#2de2e6;  /* cyan */
      --good:#2dd4bf;
      --bad:#fb7185;

      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --glow: 0 0 0 3px rgba(124,92,255,.15), 0 18px 40px rgba(0,0,0,.35);

      --radius:18px;
      --radius2:22px;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box;}
    html, body{
      height:100%;
      overscroll-behavior:none;
      -webkit-text-size-adjust:100%;
      touch-action: manipulation;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 900px at 15% -10%, rgba(124,92,255,.42), transparent 60%),
        radial-gradient(900px 700px at 110% 20%, rgba(45,226,230,.30), transparent 55%),
        radial-gradient(700px 600px at 50% 110%, rgba(45,212,191,.15), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      height:100dvh;
      overflow:hidden;
      padding: calc(12px + var(--safeTop)) 12px calc(12px + var(--safeBottom)) 12px;
      max-width: 980px;
      margin-inline:auto;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:10px;
      flex:0 0 auto;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.25px;
      font-weight:900;
      opacity:.95;
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .chip{
      position:relative;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(10px);
      user-select:none;
      overflow:hidden;
    }
    .chip::before{
      content:"";
      position:absolute;
      inset:-40px;
      background:
        radial-gradient(circle at 30% 30%, rgba(124,92,255,.25), transparent 45%),
        radial-gradient(circle at 70% 60%, rgba(45,226,230,.18), transparent 55%);
      opacity:.9;
      pointer-events:none;
    }
    .chip > *{position:relative;}
    .chip strong{color:var(--text);font-weight:900;}

    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }

    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      font-weight:800;
    }
    .tab.active{
      border-color: rgba(124,92,255,.70);
      background: rgba(124,92,255,.18);
      box-shadow: 0 0 0 3px rgba(124,92,255,.15);
    }

    .main{
      height: calc(100dvh - 24px - var(--safeTop) - var(--safeBottom));
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      overflow:hidden;
    }

    .divider{height:1px;background: rgba(255,255,255,.10);margin: 10px 0;}
    .small{font-size:12px;color:var(--muted);}
    .subtle{font-size:12px;color:var(--muted2);}

    button{
      appearance:none;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, opacity .15s ease, box-shadow .15s ease;
    }
    button:hover{background: rgba(255,255,255,.10);}
    button:active{transform: translateY(1px);}
    button:disabled{opacity:.45; cursor:not-allowed;}

    .btnPrimary{
      border-color: rgba(124,92,255,.60);
      background: rgba(124,92,255,.22);
      box-shadow: 0 0 0 3px rgba(124,92,255,.12);
    }
    .btnGhost{
      background: rgba(0,0,0,.10);
      border-color: rgba(255,255,255,.14);
    }
    .btnDanger{
      border-color: rgba(251,113,133,.55);
      background: rgba(251,113,133,.14);
      box-shadow: 0 0 0 3px rgba(251,113,133,.10);
    }
    .btnGood{
      border-color: rgba(45,212,191,.6);
      background: rgba(45,212,191,.13);
      box-shadow: 0 0 0 3px rgba(45,212,191,.10);
    }

    /* ===== Progress ===== */
    .progressWrap{display:flex;flex-direction:column;gap:8px;}
    .progressMeta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width .25s ease;
      box-shadow: 0 0 16px rgba(45,226,230,.25);
    }

    /* ===== Workout View ===== */
    #view-workout{
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1 1 auto;
      min-height:0;
    }

    .workoutHeaderRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    #workoutTitle{
      margin:0;
      font-size: 26px;
      font-weight: 950;
      letter-spacing:.25px;
      line-height:1.12;
      text-shadow: 0 6px 22px rgba(0,0,0,.35);
    }

    /* ACTIVE box dominates screen */
    .activePane{
      flex: 1 1 auto;
      min-height: 0;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      box-shadow: var(--glow);
      border-color: rgba(124,92,255,.38);
      display:flex;
      flex-direction:column;
    }

    .paneHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-bottom:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .paneHeader b{
      font-size:12px;
      letter-spacing:.55px;
      text-transform:uppercase;
      color:rgba(168,176,198,.92);
      font-weight:950;
    }
    .paneHeader .count{
      font-size:12px;
      color:rgba(168,176,198,.82);
    }

    .activeBody{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .activeTitleRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .activeTitle{
      font-size: 22px;
      font-weight: 950;
      line-height: 1.15;
      margin:0;
      letter-spacing:.25px;
    }
    .activeMeta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }

    .activeControls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

    .checkRow{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
    }
    .checkRow input{
      transform: scale(1.35);
      accent-color: var(--accent2);
    }
    .checkRow .label{
      font-size: 15px;
      font-weight: 950;
      flex:1;
      letter-spacing:.15px;
    }

    /* Timer (always visible on non-rack days) */
    .timerCard{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .timerBig{
      font-variant-numeric: tabular-nums;
      font-size: clamp(56px, 9vw, 84px);
      font-weight: 950;
      width: 100%;
      text-align:center;
      padding: 18px 10px;
      background:
        radial-gradient(600px 220px at 50% -20%, rgba(45,226,230,.22), transparent 55%),
        rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.08);
      user-select:none;
      transition: transform .12s ease;
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .timerBig.bump{ transform: scale(1.02); }

    .timerInner{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .timerCustomRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .timerCustomRow label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      font-weight:800;
      letter-spacing:.2px;
    }
    .timerInput{
      flex:1;
      min-width:120px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .timerBtns{
      display:flex;
      gap:10px;
      width:100%;
      flex-wrap:nowrap;
    }
    .timerBtns button{
      flex:1;
      width:100%;
      padding:12px 10px;
      font-weight:950;
      letter-spacing:.35px;
      text-transform: uppercase;
      border-radius: 16px;
    }

    .timerDisabled{
      display:none;
      padding:10px 12px;
      border-radius: 16px;
      border:1px dashed rgba(255,255,255,.16);
      color: rgba(168,176,198,.82);
      background: rgba(255,255,255,.03);
      font-weight:800;
    }

    /* Active video */
    .iframeBox{
      position:relative;
      width:100%;
      padding-top:56.25%;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:#000;
      box-shadow: 0 0 0 3px rgba(45,226,230,.08);
    }
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0;}

    /* Footer actions */
    .footerActions{
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 4px;
    }
    .navRow{display:flex;gap:10px;width:100%;}
    .navRow button{flex:1;}

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safeBottom));
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 999;
    }

    /* Celebration overlay */
    .overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding:16px;
    }
    .celebrateCard{
      width: min(520px, 92vw);
      border-radius: 18px;
      padding: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .celebrateTitle{margin:0;font-size:18px;font-weight:950;letter-spacing:.2px;}
    .celebrateMsg{margin:10px 0 0 0;color:rgba(242,244,255,.92);line-height:1.35;font-size:14px;}
    .sparkles{
      position:absolute;inset:-40px;opacity:.9;pointer-events:none;
      background:
        radial-gradient(circle at 10% 20%, rgba(124,92,255,.55), transparent 35%),
        radial-gradient(circle at 90% 30%, rgba(45,226,230,.45), transparent 40%),
        radial-gradient(circle at 50% 90%, rgba(45,212,191,.35), transparent 45%);
      filter: blur(2px);
      animation: floaty 1.4s ease-in-out infinite alternate;
    }
    @keyframes floaty{ from{ transform: translateY(0px); } to{ transform: translateY(-8px); } }
    .confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .confetti i{
      position:absolute; top:-20px;
      width:10px;height:14px;border-radius:3px;opacity:.9;
      animation: fall 1.1s linear forwards;
    }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(360deg); opacity: 1; } }

    .flash{
      position: fixed;
      inset: 0;
      z-index: 1500;
      pointer-events: none;
      background: rgba(255,255,255,.85);
      opacity: 0;
      transition: opacity .12s ease;
    }
    .flash.on{ opacity: 1; }

    /* History/Dashboard internal scroll */
    .scrollCard{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right:2px;
    }

    /* Calendar */
    #calendarWrap{ width:100%; }
    .calWeekdays{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-bottom:8px;
      color: var(--muted);
      font-size:12px;
      text-align:center;
      font-weight:850;
      letter-spacing:.2px;
    }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .calDay{
      position:relative;
      min-height: 56px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      padding:10px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .calDay:hover{ background: rgba(255,255,255,.06); }
    .calDay:active{ transform: translateY(1px); }
    .calDay.muted{ opacity:.35; cursor:default; }
    .calNum{ font-weight:950; font-size:13px; }
    .calDot{
      position:absolute; right:10px; bottom:10px;
      width:10px; height:10px; border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 3px rgba(124,92,255,.14);
    }
    .calSelected{
      border-color: rgba(45,212,191,.85);
      box-shadow: 0 0 0 3px rgba(45,212,191,.15);
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div>
      <h1>Elite Training Console</h1>
    </div>

    <div class="chips">
      <div class="chip"><strong id="todayLabel"></strong></div>
      <div class="chip">Cycle: <strong id="cycleLabel"></strong></div>
      <div class="chip" id="soundChip" style="cursor:pointer;">Sound: <strong id="soundLabel"></strong></div>
    </div>
  </div>

  <div class="nav">
    <button class="tab active" data-view="workout">Workout</button>
    <button class="tab" data-view="history">History</button>
    <button class="tab" data-view="dashboard">Dashboard</button>
  </div>
</header>

<div class="main">

  <!-- WORKOUT -->
  <section class="card" id="view-workout">

    <div class="workoutHeaderRow">
      <div>
        <div class="small">WORKOUT OF THE DAY</div>
        <h2 id="workoutTitle">Loading…</h2>
        <div class="subtle" id="workoutSubtitle"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="stopTimer" class="btnDanger">Stop Timer</button>
      </div>
    </div>

    <div class="progressWrap">
      <div class="progressMeta">
        <div id="progressText">0 / 0 complete</div>
        <div class="small" id="completeHint"></div>
      </div>
      <div class="bar"><div id="progressBar"></div></div>
    </div>

    <!-- ACTIVE DOMINATES -->
    <div class="activePane">
      <div class="paneHeader">
        <b>Active</b>
        <div class="count" id="activeCount">—</div>
      </div>

      <div class="activeBody">
        <div class="activeTitleRow">
          <div>
            <p class="activeTitle" id="activeTitle">—</p>
            <div class="activeMeta" id="activeMeta"></div>
          </div>

          <div class="activeControls">
            <button id="activePrevBtn" class="btnGhost">Prev</button>
            <button id="activeNextBtn" class="btnGhost">Next</button>
          </div>
        </div>

        <div class="checkRow" id="activeCheckRow">
          <input id="activeCheckbox" type="checkbox" />
          <div class="label" id="activeLabel">—</div>
        </div>

        <!-- Active video -->
        <div class="iframeBox" id="activeVideoBox" style="display:none;">
          <iframe id="activeVideoFrame"
                  src=""
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
        </div>

        <!-- Timer ALWAYS PRESENT ON NON-RACK DAYS -->
        <div class="timerCard" id="timerCard">
          <div class="timerBig" id="timerBig">60s</div>
          <div class="timerInner">
            <div class="subtle" id="timerExerciseName">—</div>

            <div class="timerDisabled" id="timerDisabled">
              No timer for this exercise. Move on, or set a custom timer anyway.
            </div>

            <div class="timerCustomRow">
              <label for="timerSecondsInput">Custom seconds</label>
              <input id="timerSecondsInput" class="timerInput" inputmode="numeric" pattern="[0-9]*" placeholder="60" />
            </div>

            <div class="timerBtns">
              <button id="timerStartPause" class="btnPrimary">Start</button>
              <button id="timerStop" class="btnDanger">Stop</button>
              <button id="timerReset">Reset</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="footerActions">
      <div class="divider"></div>

      <button id="markCompleteBtn" class="btnPrimary" style="width:100%;" disabled>
        Mark Workout Complete
      </button>

      <div class="navRow">
        <button id="prevBtn" class="btnGhost">Previous Workout</button>
        <button id="nextBtn" class="btnGhost">Next Workout</button>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section class="card" id="view-history" style="display:none;">
    <div class="workoutHeaderRow">
      <div>
        <h2 style="margin:0;font-size:18px;font-weight:950;">Completion Calendar</h2>
        <div class="small">Tap a day with a dot to view/edit completions.</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="calPrev" class="btnGhost">◀</button>
        <div class="chip"><strong id="calMonthLabel">Month</strong></div>
        <button id="calNext" class="btnGhost">▶</button>
        <button id="clearHistory" class="btnDanger">Clear</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="scrollCard" id="calendarWrap">
      <div class="calWeekdays" id="calWeekdays"></div>
      <div class="calGrid" id="calGrid"></div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section class="card" id="view-dashboard" style="display:none;">
    <div class="workoutHeaderRow">
      <div>
        <h2 style="margin:0;font-size:18px;font-weight:950;">Performance Dashboard</h2>
        <div class="small">High-level stats.</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="scrollCard">
      <div id="dashList" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </section>

</div>

<div class="toast" id="toast"></div>

<!-- Celebration -->
<div class="overlay" id="overlay">
  <div class="celebrateCard">
    <div class="sparkles"></div>
    <div class="confetti" id="confetti"></div>
    <h3 class="celebrateTitle">Workout Complete ✅</h3>
    <p class="celebrateMsg" id="celebrateMsg"></p>
    <div class="small" style="margin-top:10px;color:rgba(168,176,198,.9);">Tap anywhere to dismiss.</div>
  </div>
</div>

<!-- Day modal -->
<div class="overlay" id="dayOverlay" style="display:none;">
  <div class="celebrateCard" style="width:min(760px,92vw);">
    <h3 class="celebrateTitle" id="dayModalTitle">Completed Workouts</h3>
    <p class="celebrateMsg" id="dayModalSubtitle" style="margin-top:6px;color:rgba(168,176,198,.92);"></p>
    <div class="divider"></div>
    <div id="dayModalList" style="max-height:55dvh; overflow:auto; -webkit-overflow-scrolling:touch; display:flex; flex-direction:column; gap:10px;"></div>
    <div class="divider"></div>
    <button id="dayModalClose" class="btnPrimary" style="width:100%;">Close</button>
  </div>
</div>

<div class="flash" id="flash"></div>

<script>
/* ===========================
   LOCAL DATE KEY (America/Chicago)
   =========================== */
function getLocalDateKey() {
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: "America/Chicago",
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  }).format(new Date());
}
let todayKey = getLocalDateKey();

/* DEFAULT FALLBACK */
const DEFAULT_WORKOUTS = [
  {
    id: "w1",
    title: "Workout 1 – Rack Upper (Fallback)",
    videos: [
      { label: "Rack Video #2", url: "https://www.youtube.com/watch?v=agELHJBNCuw&t=2s" },
      { label: "Rack Video #4", url: "https://www.youtube.com/watch?v=1Kj-OLK9VR0" }
    ],
    exercises: [
      { label: "Rack Video #2", type: "videoRef" },
      { label: "Rack Video #4", type: "videoRef" }
    ]
  }
];

/* STORAGE KEYS (DON'T CHANGE) */
const STORAGE_KEY = "workout_app_state_v_calendar_json1";
const SOUND_KEY   = "sound_enabled_global_v_calendar_json1";

const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  setTimeout(()=> toastEl.style.display = "none", 1700);
}
function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function toEmbedUrl(url){
  if(!url) return "";
  const m = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{6,})/);
  if(!m) return "";
  return `https://www.youtube.com/embed/${m[1]}`;
}
function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return m>0 ? `${m}:${String(s).padStart(2,"0")}` : `${sec}s`;
}
function flashScreen(){
  const f = $("flash");
  f.classList.add("on");
  setTimeout(()=>f.classList.remove("on"), 110);
  setTimeout(()=>f.classList.add("on"), 230);
  setTimeout(()=>f.classList.remove("on"), 340);
}

/* ===========================
   SOUND
   =========================== */
let soundEnabled = (localStorage.getItem(SOUND_KEY) ?? "true") === "true";
let audioCtx = null;
let audioUnlocked = false;

function ensureAudio(){
  if(!audioCtx){
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return null;
    audioCtx = new AudioCtx();
  }
  return audioCtx;
}
async function unlockAudio(){
  try{
    const ctx = ensureAudio();
    if(!ctx) return;
    if(ctx.state === "suspended") await ctx.resume();
    audioUnlocked = true;
  }catch{}
}
function setSoundEnabled(v){
  soundEnabled = v;
  localStorage.setItem(SOUND_KEY, v ? "true" : "false");
  $("soundLabel").textContent = v ? "On" : "Off";
}
function beep(freq=880, ms=120){
  if(!soundEnabled) return;
  const ctx = ensureAudio();
  if(!ctx) return;
  if(ctx.state === "suspended") return;
  try{
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine"; o.frequency.value = freq;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, ms);
  }catch{}
}
function successChime(){ beep(880,120); setTimeout(()=>beep(1175,140),140); }
["pointerdown","touchstart","keydown"].forEach(evt=>{
  window.addEventListener(evt, ()=>{ if(!audioUnlocked) unlockAudio(); }, { once:true, passive:true });
});

/* ===========================
   LOAD WORKOUTS FROM workouts.json
   =========================== */
let WORKOUTS = [];
async function loadWorkoutsFromFile(){
  try{
    const res = await fetch("./workouts.json", { cache: "no-store" });
    if(!res.ok) throw new Error("Missing workouts.json");
    const data = await res.json();
    if(!Array.isArray(data) || data.length === 0) throw new Error("Invalid workouts.json");
    WORKOUTS = data;
  }catch(err){
    console.warn("Using DEFAULT_WORKOUTS fallback:", err);
    WORKOUTS = DEFAULT_WORKOUTS;
    toast("Using fallback workouts (workouts.json not loaded)");
  }
}

/* ===========================
   APP STATE
   =========================== */
const defaultState = {
  lastDate: "",
  currentIndex: 0,
  checks: {},
  history: [],
  activeByKey: {},
  timer: { running:false, remaining:0, duration:0, workoutId:"", exerciseIndex:-1 },
  timerOverrides: {}
};
let state = loadJSON(STORAGE_KEY, defaultState);
let currentIndex = 0;
let timerInterval = null;

/* ===========================
   HELPERS
   =========================== */
function stopTimerHard(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  state.timer.running = false;
  saveJSON(STORAGE_KEY, state);
}
function workoutDayKey(workoutId){ return `${todayKey}::${workoutId}`; }
function getChecksFor(workoutId){ return state.checks[workoutDayKey(workoutId)] || {}; }
function setCheck(workoutId, itemIndex, value){
  const k = workoutDayKey(workoutId);
  if(!state.checks[k]) state.checks[k] = {};
  state.checks[k][itemIndex] = value;
  saveJSON(STORAGE_KEY, state);
}
function isCheckable(ex){ return ex.type !== "section"; }
function isTimed(ex){ return typeof ex.seconds === "number" && ex.seconds > 0; }
function isRackDay(workout){
  const checkable = workout.exercises.filter(isCheckable);
  if(checkable.length === 0) return false;
  return checkable.every(ex => ex.type === "videoRef");
}
function findFirstUncheckedIndex(workout){
  const checks = getChecksFor(workout.id);
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i]) && !checks[i]) return i;
  }
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return 0;
}
function setActiveIndex(workoutId, idx){
  state.activeByKey[workoutDayKey(workoutId)] = idx;
  saveJSON(STORAGE_KEY, state);
}
function getActiveIndex(workout){
  const k = workoutDayKey(workout.id);
  const saved = state.activeByKey[k];
  if(typeof saved === "number") return saved;
  const first = findFirstUncheckedIndex(workout);
  setActiveIndex(workout.id, first);
  return first;
}
function computeCompletion(workout){
  const checks = getChecksFor(workout.id);
  const checkableIdx = workout.exercises
    .map((ex,i)=>({ex,i}))
    .filter(({ex})=>isCheckable(ex))
    .map(({i})=>i);

  const done = checkableIdx.filter(i => !!checks[i]).length;
  const total = checkableIdx.length;
  const pct = total ? Math.round((done/total)*100) : 0;
  return { done, total, pct, allDone: total > 0 && done === total, checkableIdx };
}
function updateProgressAndComplete(workout){
  const { done, total, pct, allDone } = computeCompletion(workout);
  $("progressText").textContent = `${done} / ${total} complete`;
  $("progressBar").style.width = `${pct}%`;
  $("workoutSubtitle").textContent = `Completion: ${pct}%`;
  $("completeHint").textContent = allDone ? "Ready to complete" : "Complete all exercises to unlock";
  $("markCompleteBtn").disabled = !allDone;
}
function findVideoForExercise(workout, exerciseLabel){
  const vids = Array.isArray(workout.videos) ? workout.videos : [];
  return vids.find(v => v.label === exerciseLabel) || vids.find(v => exerciseLabel.includes(v.label));
}
function displayTypeMeta(ex){
  if(ex?.type === "videoRef") return ["Video"];
  if(ex && isTimed(ex)) return ["Timed", formatTime(ex.seconds)];
  return ["Exercise"];
}
function findNextCheckableIndex(workout, fromIdx){
  for(let i=fromIdx+1;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return null;
}
function findPrevCheckableIndex(workout, fromIdx){
  for(let i=fromIdx-1;i>=0;i--){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return null;
}

/* ===========================
   HISTORY SNAPSHOT
   =========================== */
function addHistoryEntry(workout){
  const entry = {
    date: todayKey,
    title: workout.title,
    workoutId: workout.id,
    ts: Date.now(),
    workoutSnapshot: JSON.parse(JSON.stringify(workout))
  };
  const exists = state.history.some(h => h.date === entry.date && h.title === entry.title);
  if(!exists){
    state.history.unshift(entry);
    saveJSON(STORAGE_KEY, state);
  }
}

/* ===========================
   VIEW SWITCH
   =========================== */
function setView(view){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.view===view));
  $("view-workout").style.display = view==="workout" ? "flex" : "none";
  $("view-history").style.display = view==="history" ? "block" : "none";
  $("view-dashboard").style.display = view==="dashboard" ? "block" : "none";
  if(view==="history") renderHistory();
  if(view==="dashboard") renderDashboard();
}

/* ===========================
   CELEBRATION
   =========================== */
const CELEBRATION_MESSAGES = [
  "Good job not being a total fucking loser today.",
  "Congrats. You moved your body. The bar is low, but you cleared it.",
  "You did the workout. Try not to pass out from the responsibility.",
  "Look at you, doing hard things on purpose.",
  "Another workout completed. Shocking behavior."
];
function spawnConfetti(){
  const box = $("confetti");
  box.innerHTML = "";
  const n = 26;
  for(let i=0;i<n;i++){
    const p = document.createElement("i");
    p.style.left = Math.random()*100 + "%";
    p.style.animationDelay = (Math.random()*0.15) + "s";
    const colors = ["rgba(124,92,255,.9)","rgba(45,226,230,.9)","rgba(45,212,191,.9)","rgba(255,255,255,.85)"];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.width = (8 + Math.random()*6) + "px";
    p.style.height = (10 + Math.random()*8) + "px";
    box.appendChild(p);
  }
}
let celebrationTimeout = null;
function hideCelebration(){
  $("overlay").style.display = "none";
  if(celebrationTimeout) clearTimeout(celebrationTimeout);
  celebrationTimeout = null;
}
function showCelebration(){
  const msg = CELEBRATION_MESSAGES[Math.floor(Math.random()*CELEBRATION_MESSAGES.length)];
  $("celebrateMsg").textContent = msg;
  spawnConfetti();
  $("overlay").style.display = "flex";
  successChime();
  if(navigator.vibrate) navigator.vibrate([80,40,80]);
  if(celebrationTimeout) clearTimeout(celebrationTimeout);
  celebrationTimeout = setTimeout(hideCelebration, 10000);
}
$("overlay").addEventListener("click", hideCelebration);

/* ===========================
   DASHBOARD
   =========================== */
function computeStreak(){
  const days = new Set(state.history.map(h => h.date));
  let streak = 0;
  const d = new Date();
  while(true){
    const k = new Intl.DateTimeFormat("en-CA", {
      timeZone: "America/Chicago",
      year: "numeric",
      month: "2-digit",
      day: "2-digit"
    }).format(d);
    if(days.has(k)){ streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  return streak;
}
function renderDashboard(){
  const list = $("dashList");
  list.innerHTML = "";
  const total = state.history.length;
  const streak = computeStreak();
  const recent = state.history[0]?.date ?? "—";
  const w = WORKOUTS[currentIndex];
  const { pct } = computeCompletion(w);

  const mk = (k,v,sub="") => {
    const it = document.createElement("div");
    it.className = "card";
    it.style.padding = "12px";
    it.innerHTML = `<div class="small"><b>${k}</b></div><div style="font-size:18px;font-weight:950;margin-top:6px;">${v}</div>${sub?`<div class="small" style="margin-top:4px;">${sub}</div>`:""}`;
    return it;
  };
  list.appendChild(mk("Workouts Completed (All Time)", total));
  list.appendChild(mk("Current Streak", streak, "Days in a row"));
  list.appendChild(mk("Most Recent Completion", recent));
  list.appendChild(mk("Current Workout Completion Rate", `${pct}%`));
}

/* ===========================
   TIMER OVERRIDES
   =========================== */
function timerOverrideKey(workoutId, exerciseIndex){ return `${workoutId}::${exerciseIndex}`; }
function getOverrideSeconds(workoutId, exerciseIndex){
  const k = timerOverrideKey(workoutId, exerciseIndex);
  const v = state.timerOverrides?.[k];
  return (Number.isFinite(v) && v >= 10 && v <= 600) ? v : null;
}
function setOverrideSeconds(workoutId, exerciseIndex, seconds){
  if(!state.timerOverrides) state.timerOverrides = {};
  const k = timerOverrideKey(workoutId, exerciseIndex);
  state.timerOverrides[k] = seconds;
  saveJSON(STORAGE_KEY, state);
}

/* ===========================
   TIMER
   =========================== */
function readCustomSeconds(){
  const raw = ($("timerSecondsInput").value || "").trim();
  if(raw === "") return null;
  const n = parseInt(raw, 10);
  if(Number.isFinite(n) && n >= 10 && n <= 600) return n;
  return null;
}
function setInputPlaceholder(val){ $("timerSecondsInput").placeholder = String(val); }
function bumpTimerDisplay(){
  const el = $("timerBig");
  el.classList.add("bump");
  setTimeout(()=>el.classList.remove("bump"), 120);
}
function applyCustomDurationIfAny(){
  const custom = readCustomSeconds();
  if(custom == null) return false;

  const w = WORKOUTS[currentIndex];
  const idx = state.timer.exerciseIndex;

  pauseTimer();
  state.timer.duration = custom;
  state.timer.remaining = custom;
  setOverrideSeconds(w.id, idx, custom);

  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
  beep(660,50);
  return true;
}
function tickTimer(){
  state.timer.remaining -= 1;
  if(state.timer.remaining < 0) state.timer.remaining = 0;
  bumpTimerDisplay();

  if(state.timer.remaining === 0){
    saveJSON(STORAGE_KEY, state);
    const workout = WORKOUTS[currentIndex];
    const idx = state.timer.exerciseIndex;

    stopTimerHard();
    flashScreen();
    toast("Timer finished ✅");
    beep(950,100);
    setTimeout(()=>beep(760,120), 140);

    const checks = getChecksFor(workout.id);
    if(!checks[idx]) setCheck(workout.id, idx, true);

    const nextIdx = findFirstUncheckedIndex(workout);
    setActiveIndex(workout.id, nextIdx);

    renderWorkout();
    updateProgressAndComplete(workout);
    return;
  }

  if(state.timer.remaining <= 5) beep(950,40);

  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
}
function startTimer(){
  if(timerInterval) return;
  applyCustomDurationIfAny();
  state.timer.running = true;
  saveJSON(STORAGE_KEY, state);
  $("timerStartPause").textContent = "Pause";
  beep(520,70);
  timerInterval = setInterval(tickTimer, 1000);
}
function pauseTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  state.timer.running = false;
  saveJSON(STORAGE_KEY, state);
  $("timerStartPause").textContent = "Start";
}
function resetTimer(){
  pauseTimer();
  const workout = WORKOUTS[currentIndex];
  const idx = state.timer.exerciseIndex;

  const ex = workout.exercises[idx];
  const defaultSeconds = (ex && isTimed(ex)) ? ex.seconds : 60;
  const override = getOverrideSeconds(workout.id, idx);
  const desired = override ?? defaultSeconds;

  state.timer.duration = desired;
  state.timer.remaining = desired;
  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
  beep(660,50);
}
function stopTimer(){
  pauseTimer();
  toast("Timer stopped");
}

/* ===========================
   RENDER WORKOUT
   =========================== */
function renderWorkout(){
  todayKey = getLocalDateKey();
  $("todayLabel").textContent = `Today: ${todayKey}`;

  if(state.lastDate !== todayKey){
    state.lastDate = todayKey;
    saveJSON(STORAGE_KEY, state);
  }
  if(state.timer.running && !timerInterval){
    state.timer.running = false;
    saveJSON(STORAGE_KEY, state);
  }

  const workout = WORKOUTS[currentIndex];
  $("workoutTitle").textContent = workout.title;
  $("cycleLabel").textContent = `${currentIndex + 1} / ${WORKOUTS.length}`;
  setSoundEnabled(soundEnabled);

  const rack = isRackDay(workout);
  $("stopTimer").style.display = rack ? "none" : "inline-block";

  const checks = getChecksFor(workout.id);

  let activeIdx = getActiveIndex(workout);
  if(isCheckable(workout.exercises[activeIdx]) && checks[activeIdx]){
    activeIdx = findFirstUncheckedIndex(workout);
    setActiveIndex(workout.id, activeIdx);
  }

  const activeEx = workout.exercises[activeIdx];

  $("activeCount").textContent = `${activeIdx+1} / ${workout.exercises.length}`;
  $("activeTitle").textContent = activeEx?.label ?? "—";
  $("activeLabel").textContent = activeEx?.label ?? "—";

  const meta = $("activeMeta");
  meta.innerHTML = "";
  const bits = displayTypeMeta(activeEx);
  bits.forEach((m, k)=>{
    const s = document.createElement("span");
    s.textContent = m;
    meta.appendChild(s);
    if(k < bits.length-1){
      const dot = document.createElement("span");
      dot.textContent = "•";
      dot.style.opacity = ".6";
      meta.appendChild(dot);
    }
  });

  $("activeCheckbox").checked = !!checks[activeIdx];

  $("activeCheckRow").onclick = (e)=>{
    if(e.target && e.target.id === "activeCheckbox") return;
    $("activeCheckbox").checked = !$("activeCheckbox").checked;
    $("activeCheckbox").dispatchEvent(new Event("change"));
  };
  $("activeCheckbox").onchange = ()=>{
    const checked = $("activeCheckbox").checked;
    if(!checked) stopTimerHard();
    setCheck(workout.id, activeIdx, checked);

    if(checked){
      beep(660,60);
      const nextUnchecked = findFirstUncheckedIndex(workout);
      setActiveIndex(workout.id, nextUnchecked);
      stopTimerHard();
    } else {
      setActiveIndex(workout.id, activeIdx);
      stopTimerHard();
    }
    renderWorkout();
    updateProgressAndComplete(workout);
  };

  // Prev/Next within workout
  const prevIdx = findPrevCheckableIndex(workout, activeIdx);
  const nextIdx = findNextCheckableIndex(workout, activeIdx);
  $("activePrevBtn").disabled = prevIdx === null;
  $("activeNextBtn").disabled = nextIdx === null;

  // Video
  const videoBox = $("activeVideoBox");
  const videoFrame = $("activeVideoFrame");
  if(activeEx?.type === "videoRef"){
    const vid = findVideoForExercise(workout, activeEx.label);
    const embed = toEmbedUrl(vid?.url || "");
    if(embed){
      videoFrame.src = embed;
      videoBox.style.display = "block";
    } else {
      videoFrame.src = "";
      videoBox.style.display = "none";
    }
  } else {
    videoFrame.src = "";
    videoBox.style.display = "none";
  }

  // Timer logic:
  // - Rack day: show timer card but disable (so you still SEE it and can optionally use custom)
  // - Non-rack day: always show timer card; if exercise has seconds -> uses that; else uses 60
  const timerDisabled = $("timerDisabled");
  const hasSeconds = (!rack && activeEx && isTimed(activeEx));

  let defaultSeconds = 60;
  if(!rack && activeEx && isTimed(activeEx)) defaultSeconds = activeEx.seconds;

  // Keep timer bound to current workout+exercise so it resets on exercise change
  const needsReset =
    state.timer.workoutId !== workout.id ||
    state.timer.exerciseIndex !== activeIdx;

  const override = getOverrideSeconds(workout.id, activeIdx);
  const desired = override ?? defaultSeconds;

  if(needsReset){
    stopTimerHard();
    state.timer = { running:false, remaining: desired, duration: desired, workoutId: workout.id, exerciseIndex: activeIdx };
    $("timerSecondsInput").value = "";
    setInputPlaceholder(desired);
    saveJSON(STORAGE_KEY, state);
  } else {
    setInputPlaceholder(desired);
  }

  $("timerBig").textContent = formatTime(state.timer.remaining);
  $("timerExerciseName").textContent =
    rack ? "Rack day timer (optional)" :
    (hasSeconds ? `Default ${formatTime(defaultSeconds)}${override ? " • Custom " + formatTime(override) : ""}` :
                 `Default ${formatTime(defaultSeconds)} (no timed value in JSON)${override ? " • Custom " + formatTime(override) : ""}`);

  // On rack days OR non-timed exercises, show the “disabled” callout (but timer still usable if you want)
  timerDisabled.style.display = (rack || !hasSeconds) ? "block" : "none";

  $("timerStartPause").textContent = state.timer.running ? "Pause" : "Start";

  updateProgressAndComplete(workout);
}

/* ===========================
   HISTORY + EDIT COMPLETION DATE
   =========================== */
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();

function ymd(y,m,d){
  const mm = String(m+1).padStart(2,"0");
  const dd = String(d).padStart(2,"0");
  return `${y}-${mm}-${dd}`;
}
function formatMonthLabel(y,m){
  const dt = new Date(y, m, 1);
  return dt.toLocaleString(undefined, { month:"long", year:"numeric" });
}
function historyByDate(){
  const map = {};
  for(const h of state.history){
    if(!map[h.date]) map[h.date] = [];
    map[h.date].push(h);
  }
  return map;
}
function renderHistory(){
  const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  $("calWeekdays").innerHTML = weekdays.map(w => `<div>${w}</div>`).join("");
  $("calGrid").innerHTML = "";
  $("calMonthLabel").textContent = formatMonthLabel(calYear, calMonth);

  const first = new Date(calYear, calMonth, 1);
  const startDay = first.getDay();
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  const byDate = historyByDate();

  for(let i=0;i<startDay;i++){
    const cell = document.createElement("div");
    cell.className = "calDay muted";
    cell.innerHTML = `<div class="calNum"> </div>`;
    $("calGrid").appendChild(cell);
  }

  for(let d=1; d<=daysInMonth; d++){
    const key = ymd(calYear, calMonth, d);
    const doneList = byDate[key] || [];

    const cell = document.createElement("div");
    cell.className = "calDay";
    if(key === todayKey) cell.classList.add("calSelected");
    cell.innerHTML = `<div class="calNum">${d}</div>`;

    if(doneList.length >= 1){
      const dot = document.createElement("div");
      dot.className = "calDot";
      cell.appendChild(dot);
    }

    cell.addEventListener("click", ()=>{
      if(doneList.length === 0){
        toast("No completed workout that day");
        return;
      }
      openDayModal(key, doneList);
    });

    $("calGrid").appendChild(cell);
  }
}
function updateHistoryEntryDate(entryTs, newDate){
  const idx = state.history.findIndex(h => h.ts === entryTs);
  if(idx === -1) return false;
  if(!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) return false;
  state.history[idx].date = newDate;
  saveJSON(STORAGE_KEY, state);
  return true;
}
function openDayModal(dateKey, entries){
  const overlay = $("dayOverlay");
  $("dayModalTitle").textContent = `Completed on ${dateKey}`;
  $("dayModalSubtitle").textContent = `${entries.length} workout${entries.length===1?"":"s"} completed`;
  const list = $("dayModalList");
  list.innerHTML = "";

  entries.slice().sort((a,b)=>a.ts-b.ts).forEach((entry)=>{
    const it = document.createElement("div");
    it.className = "card";
    it.style.padding = "12px";
    const timeStr = new Date(entry.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    it.innerHTML = `
      <div class="small"><b>${timeStr}</b></div>
      <div style="font-style: italic; font-weight: 950; margin-top:6px;">${entry.title}</div>
      <div class="small" style="margin-top:10px;">Edit date</div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px;">
        <input type="date" class="timerInput" style="max-width:190px;" value="${entry.date}">
        <button class="btnGood">Save</button>
      </div>
    `;
    const dateInput = it.querySelector('input[type="date"]');
    const saveBtn = it.querySelector("button.btnGood");
    saveBtn.addEventListener("click", ()=>{
      const ok = updateHistoryEntryDate(entry.ts, dateInput.value);
      if(ok){
        toast("Date updated");
        renderHistory();
      } else toast("Could not update date");
    });
    list.appendChild(it);
  });

  overlay.style.display = "flex";
}
$("dayModalClose").addEventListener("click", ()=>{ $("dayOverlay").style.display = "none"; });
$("dayOverlay").addEventListener("click", (e)=>{ if(e.target.id === "dayOverlay") $("dayOverlay").style.display = "none"; });

/* ===========================
   TIMER INPUT EVENTS
   =========================== */
$("timerSecondsInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    applyCustomDurationIfAny();
    $("timerSecondsInput").blur();
    renderWorkout();
  }
});
$("timerSecondsInput").addEventListener("blur", ()=>{
  const custom = readCustomSeconds();
  if(custom != null){
    const w = WORKOUTS[currentIndex];
    const idx = state.timer.exerciseIndex;
    setOverrideSeconds(w.id, idx, custom);
    if(!state.timer.running){
      state.timer.duration = custom;
      state.timer.remaining = custom;
      saveJSON(STORAGE_KEY, state);
      $("timerBig").textContent = formatTime(state.timer.remaining);
    }
    toast("Custom timer saved");
  }
});

/* ===========================
   VIEW TABS
   =========================== */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setView(t.dataset.view));
});

$("soundChip").addEventListener("click", async ()=>{
  await unlockAudio();
  setSoundEnabled(!soundEnabled);
  toast(soundEnabled ? "Sound ON" : "Sound OFF");
});

/* Workout navigation */
$("prevBtn").addEventListener("click", ()=>{
  pauseTimer();
  currentIndex = (currentIndex - 1 + WORKOUTS.length) % WORKOUTS.length;
  state.currentIndex = currentIndex;
  saveJSON(STORAGE_KEY, state);
  renderWorkout();
});
$("nextBtn").addEventListener("click", ()=>{
  pauseTimer();
  currentIndex = (currentIndex + 1) % WORKOUTS.length;
  state.currentIndex = currentIndex;
  saveJSON(STORAGE_KEY, state);
  renderWorkout();
});

/* Active exercise prev/next */
$("activePrevBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const activeIdx = getActiveIndex(w);
  const prev = findPrevCheckableIndex(w, activeIdx);
  if(prev === null) return;
  stopTimerHard();
  setActiveIndex(w.id, prev);
  renderWorkout();
});
$("activeNextBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const activeIdx = getActiveIndex(w);
  const next = findNextCheckableIndex(w, activeIdx);
  if(next === null) return;
  stopTimerHard();
  setActiveIndex(w.id, next);
  renderWorkout();
});

/* Timer buttons */
$("stopTimer").addEventListener("click", ()=>{
  stopTimerHard();
  toast("Timer stopped");
  renderWorkout();
});
$("timerStartPause").addEventListener("click", async ()=>{
  await unlockAudio();
  if(state.timer.running) pauseTimer();
  else startTimer();
  renderWorkout();
});
$("timerStop").addEventListener("click", ()=>{
  stopTimer();
  stopTimerHard();
  renderWorkout();
});
$("timerReset").addEventListener("click", ()=>{
  const custom = readCustomSeconds();
  if(custom != null){
    const w = WORKOUTS[currentIndex];
    const idx = state.timer.exerciseIndex;
    pauseTimer();
    setOverrideSeconds(w.id, idx, custom);
    state.timer.duration = custom;
    state.timer.remaining = custom;
    saveJSON(STORAGE_KEY, state);
    $("timerBig").textContent = formatTime(state.timer.remaining);
    beep(660,50);
  } else resetTimer();
  renderWorkout();
});

/* Mark workout complete */
$("markCompleteBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const { allDone } = computeCompletion(w);
  if(!allDone){ toast("Complete all exercises first"); return; }
  addHistoryEntry(w);
  showCelebration();
  setTimeout(()=>{
    pauseTimer();
    currentIndex = (currentIndex + 1) % WORKOUTS.length;
    state.currentIndex = currentIndex;
    saveJSON(STORAGE_KEY, state);
    renderWorkout();
  }, 950);
});

/* Calendar controls */
$("clearHistory").addEventListener("click", ()=>{
  if(!confirm("Clear all workout history?")) return;
  state.history = [];
  saveJSON(STORAGE_KEY, state);
  renderHistory();
  toast("History cleared");
});
$("calPrev").addEventListener("click", ()=>{
  calMonth -= 1;
  if(calMonth < 0){ calMonth = 11; calYear -= 1; }
  renderHistory();
});
$("calNext").addEventListener("click", ()=>{
  calMonth += 1;
  if(calMonth > 11){ calMonth = 0; calYear += 1; }
  renderHistory();
});

/* ===========================
   INIT
   =========================== */
(async function init(){
  await loadWorkoutsFromFile();

  state = { ...defaultState, ...state };
  if(!state.timerOverrides) state.timerOverrides = {};

  todayKey = getLocalDateKey();
  if(state.lastDate !== todayKey){
    state.lastDate = todayKey;
    saveJSON(STORAGE_KEY, state);
  }

  if (typeof state.currentIndex !== "number") state.currentIndex = 0;
  if (state.currentIndex < 0 || state.currentIndex >= WORKOUTS.length) state.currentIndex = 0;
  currentIndex = state.currentIndex;

  const now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth();

  setView("workout");
  $("todayLabel").textContent = `Today: ${todayKey}`;
  renderWorkout();
  renderDashboard();
})();
</script>
</body>
</html>
