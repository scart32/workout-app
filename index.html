<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workout App</title>
  <style>
    :root{
      color-scheme: dark;
      --bg0:#0a0b10;
      --bg1:#0f1220;
      --text:#f2f4ff;
      --muted:#a8b0c6;
      --accent:#7c5cff;
      --accent2:#2de2e6;
      --good:#2dd4bf;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
                  radial-gradient(900px 700px at 110% 20%, rgba(45,226,230,.25), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      padding:16px;
      max-width: 920px;
      margin-inline:auto;
    }
    header{display:flex;flex-direction:column;gap:12px;margin-bottom:14px;}
    .topbar{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    h1{margin:0;font-size:20px;letter-spacing:.2px;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
      user-select:none;
    }
    .chip strong{color:var(--text);font-weight:600;}

    .nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);cursor:pointer;font-size:13px;
    }
    .tab.active{
      border-color: rgba(124,92,255,.7);
      box-shadow: 0 0 0 3px rgba(124,92,255,.15);
      background: rgba(124,92,255,.18);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .row{display:flex;gap:12px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;}
    .titleBlock{display:flex;flex-direction:column;gap:6px;min-width: 260px;}

    /* Bigger, bolder workout title */
    #workoutTitle{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.15;
    }

    .small{font-size:12px;color:var(--muted);}

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      width:auto;
    }
    button:hover{background: rgba(255,255,255,.10);}
    button:active{transform: translateY(1px);}
    button:disabled{opacity:.45; cursor:not-allowed;}
    .btnPrimary{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.22);
    }
    .btnGhost{background: transparent;border-color: rgba(255,255,255,.14);}
    .btnDanger{border-color: rgba(251,113,133,.55);background: rgba(251,113,133,.15);}

    .progressWrap{margin-top:12px;display:flex;flex-direction:column;gap:8px;}
    .progressMeta{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;}
    .bar{height: 10px;border-radius: 999px;background: rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden;}
    .bar > div{height:100%;width:0%;background: linear-gradient(90deg, var(--accent), var(--accent2));border-radius: 999px;transition: width .25s ease;}

    /* Global Timer (Full Width) */
    .globalTimer{
      margin-top:12px;
      display:none;
      width:100%;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .timerTop{display:flex;flex-direction:column;gap:10px;width:100%;}
    .timerBig{
      font-variant-numeric: tabular-nums;
      font-size: 52px;
      font-weight: 950;
      width: 100%;
      text-align:center;
      padding:14px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .timerMeta{display:flex;flex-direction:column;gap:3px;width:100%;}
    .timerMeta .k{color:var(--muted); font-size: 12px;}
    .timerMeta .v{color:var(--text); font-size: 14px; font-weight: 800;}
    .timerCustomRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;width:100%;}
    .timerCustomRow label{font-size:12px;color:var(--muted);white-space:nowrap;}
    .timerInput{
      flex:1;min-width:120px;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    .timerBtns{display:flex;gap:10px;width:100%;flex-wrap:nowrap;}
    .timerBtns button{
      flex:1;width:100%;
      border-radius: 14px;
      padding:12px 10px;
      font-weight: 800;
    }

    .videosGrid{display:grid;grid-template-columns: 1fr;gap:12px;margin-top:14px;}
    @media (min-width: 820px){.videosGrid{grid-template-columns: 1fr 1fr;}}
    .iframeBox{position:relative;width:100%;padding-top:56.25%;border-radius: 14px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:#000;}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0;}

    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px;}
    .item{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition: border-color .15s ease, background .15s ease, transform .05s ease, opacity .15s ease;
      cursor: pointer;
    }
    .item:active{transform: translateY(1px);}
    .item.active{
      border-color: rgba(45,212,191,.8);
      box-shadow: 0 0 0 3px rgba(45,212,191,.15);
      opacity: 1;
    }
    .item.section{
      cursor: default;
      background: rgba(255,255,255,.05);
      border-style: dashed;
      opacity: 1;
    }
    .topline{display:flex;gap:10px;align-items:flex-start;}
    .topline input{transform: scale(1.35);margin-top:2px;accent-color: var(--accent2);}
    .name{font-size:13.5px;line-height:1.25;flex:1;}
    .done .name{text-decoration: line-through;color: rgba(168,176,198,.75);}

    .collapsed .meta, .collapsed .iframeBox { display:none; }
    .collapsed{opacity:.72;}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color: var(--muted);font-size: 12px;}

    .divider{height:1px;background: rgba(255,255,255,.10);margin: 14px 0;}

    .toast{
      position: fixed;left: 50%;transform: translateX(-50%);
      bottom: 18px;background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      padding: 10px 12px;border-radius: 999px;
      font-size: 12px;color: var(--text);
      backdrop-filter: blur(10px);
      display:none;z-index: 999;
    }

    /* Celebration overlay */
    .overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .celebrateCard{
      width: min(520px, 92vw);
      border-radius: 18px;
      padding: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .celebrateTitle{margin:0;font-size:18px;font-weight:900;letter-spacing:.2px;}
    .celebrateMsg{margin:10px 0 0 0;color:rgba(242,244,255,.92);line-height:1.35;font-size:14px;}
    .sparkles{
      position:absolute;inset:-40px;opacity:.9;pointer-events:none;
      background:
        radial-gradient(circle at 10% 20%, rgba(124,92,255,.55), transparent 35%),
        radial-gradient(circle at 90% 30%, rgba(45,226,230,.45), transparent 40%),
        radial-gradient(circle at 50% 90%, rgba(45,212,191,.35), transparent 45%);
      filter: blur(2px);
      animation: floaty 1.4s ease-in-out infinite alternate;
    }
    @keyframes floaty{ from{ transform: translateY(0px); } to{ transform: translateY(-8px); } }
    .confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .confetti i{
      position:absolute; top:-20px;
      width:10px;height:14px;border-radius:3px;opacity:.9;
      animation: fall 1.1s linear forwards;
    }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(360deg); opacity: 1; } }

    /* Visual flash when timer ends */
    .flash{
      position: fixed;
      inset: 0;
      z-index: 1500;
      pointer-events: none;
      background: rgba(255,255,255,.85);
      opacity: 0;
      transition: opacity .12s ease;
    }
    .flash.on{ opacity: 1; }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <div><h1>Workout App</h1></div>
    <div class="chips">
      <div class="chip"><strong id="todayLabel"></strong></div>
      <div class="chip">Cycle: <strong id="cycleLabel"></strong></div>
      <div class="chip" id="soundChip" style="cursor:pointer;">Sound: <strong id="soundLabel"></strong></div>
    </div>
  </div>

  <div class="nav">
    <button class="tab active" data-view="workout">Workout</button>
    <button class="tab" data-view="history">History</button>
    <button class="tab" data-view="dashboard">Dashboard</button>
  </div>
</header>

<section class="card" id="view-workout">
  <div class="row">
    <div class="titleBlock">
      <h2 id="workoutTitle">Loading…</h2>
      <div class="small" id="workoutSubtitle"></div>
    </div>

    <div class="row" style="gap:8px;justify-content:flex-end;" id="topControls">
      <button id="prevBtn" class="btnGhost">Previous</button>
      <button id="nextBtn" class="btnGhost">Next</button>
      <button id="stopTimer" class="btnDanger">Stop Timer</button>
    </div>
  </div>

  <div class="progressWrap">
    <div class="progressMeta">
      <div id="progressText">0 / 0 complete</div>
      <div class="small" id="completeHint"></div>
    </div>
    <div class="bar"><div id="progressBar"></div></div>
  </div>

  <div class="globalTimer" id="globalTimer">
    <div class="timerTop">
      <div class="timerBig" id="timerBig">60s</div>
      <div class="timerMeta">
        <div class="k">Active</div>
        <div class="v" id="timerExerciseName">—</div>
      </div>

      <div class="timerCustomRow">
        <label for="timerSecondsInput">Timer seconds</label>
        <input id="timerSecondsInput" class="timerInput" inputmode="numeric" pattern="[0-9]*" placeholder="60" />
      </div>

      <div class="timerBtns">
        <button id="timerStartPause" class="btnPrimary">Start</button>
        <button id="timerStop" class="btnDanger">Stop</button>
        <button id="timerReset">Reset</button>
      </div>
    </div>
  </div>

  <div id="videosSection" class="videosGrid" style="display:none;"></div>
  <div class="list" id="exerciseList"></div>

  <div class="divider"></div>
  <button id="markCompleteBtn" class="btnPrimary" style="width:100%;" disabled>
    Mark Workout Complete
  </button>
</section>

<section class="card" id="view-history" style="display:none;">
  <div class="row">
    <div class="titleBlock">
      <h2 style="margin:0;font-size:18px;font-weight:900;">Workout Completion History</h2>
      <div class="small">Completed workouts are logged here.</div>
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end;">
      <button id="clearHistory" class="btnDanger">Clear History</button>
    </div>
  </div>
  <div class="divider"></div>
  <div id="historyList" class="list"></div>
</section>

<section class="card" id="view-dashboard" style="display:none;">
  <div class="row">
    <div class="titleBlock">
      <h2 style="margin:0;font-size:18px;font-weight:900;">Performance Dashboard</h2>
      <div class="small">High-level stats.</div>
    </div>
  </div>
  <div class="divider"></div>
  <div class="list" id="dashList"></div>
</section>

<div class="toast" id="toast"></div>

<div class="overlay" id="overlay">
  <div class="celebrateCard">
    <div class="sparkles"></div>
    <div class="confetti" id="confetti"></div>
    <h3 class="celebrateTitle">Workout Complete ✅</h3>
    <p class="celebrateMsg" id="celebrateMsg"></p>
    <div class="small" style="margin-top:10px;color:rgba(168,176,198,.9);">
      Tap anywhere to dismiss.
    </div>
  </div>
</div>

<div class="flash" id="flash"></div>

<script>
/* ===========================
   DEFAULT FALLBACK WORKOUTS
   (used only if workouts.json fails to load)
   =========================== */
const DEFAULT_WORKOUTS = [
  {
    id: "w1",
    title: "Workout 1 – Rack Upper",
    videos: [
      { label: "Rack Video #2", url: "https://www.youtube.com/watch?v=agELHJBNCuw&t=2s" },
      { label: "Rack Video #4", url: "https://www.youtube.com/watch?v=1Kj-OLK9VR0" }
    ],
    exercises: [
      { label: "Rack Video #2", type: "videoRef" },
      { label: "Rack Video #4", type: "videoRef" }
    ]
  }
];

/* ===========================
   STORAGE KEYS
   =========================== */
const STORAGE_KEY = "workout_app_state_v_json1";
const SOUND_KEY   = "sound_enabled_global_v_json1";

const todayKey = new Date().toISOString().slice(0,10);
const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");

/* ===========================
   UTIL
   =========================== */
function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  setTimeout(()=> toastEl.style.display = "none", 1600);
}
function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function toEmbedUrl(url){
  if(!url) return "";
  const m = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{6,})/);
  if(!m) return "";
  return `https://www.youtube.com/embed/${m[1]}`;
}
function getDailyIndex(len){
  const epochDays = Math.floor(Date.now() / (1000*60*60*24));
  return epochDays % len;
}
function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return m>0 ? `${m}:${String(s).padStart(2,"0")}` : `${sec}s`;
}
function flashScreen(){
  const f = $("flash");
  f.classList.add("on");
  setTimeout(()=>f.classList.remove("on"), 110);
  setTimeout(()=>f.classList.add("on"), 230);
  setTimeout(()=>f.classList.remove("on"), 340);
}

/* ===========================
   SOUND
   =========================== */
let soundEnabled = (localStorage.getItem(SOUND_KEY) ?? "true") === "true";
function setSoundEnabled(v){
  soundEnabled = v;
  localStorage.setItem(SOUND_KEY, v ? "true" : "false");
  $("soundLabel").textContent = v ? "On" : "Off";
}
function beep(freq=880, ms=120){
  if(!soundEnabled) return;
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine"; o.frequency.value = freq;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, ms);
  }catch{}
}
function successChime(){ beep(880,120); setTimeout(()=>beep(1175,140),140); }

/* ===========================
   LOAD WORKOUTS FROM workouts.json
   =========================== */
let WORKOUTS = [];

async function loadWorkoutsFromFile(){
  try{
    const res = await fetch("./workouts.json", { cache: "no-store" });
    if(!res.ok) throw new Error("Missing workouts.json");
    const data = await res.json();
    if(!Array.isArray(data) || data.length === 0) throw new Error("Invalid workouts.json");
    WORKOUTS = data;
  }catch(err){
    console.warn("Using DEFAULT_WORKOUTS fallback:", err);
    WORKOUTS = DEFAULT_WORKOUTS;
    toast("Using fallback workouts (workouts.json not loaded)");
  }
}

/* ===========================
   APP STATE
   =========================== */
const defaultState = {
  lastDate:"",
  dayIndex:0,
  checks:{},
  history:[],
  activeByKey:{},
  timer: { running:false, remaining:0, duration:0, workoutId:"", exerciseIndex:-1 }
};
let state = loadJSON(STORAGE_KEY, defaultState);
let currentIndex = 0;
let timerInterval = null;

/* ===========================
   HELPERS
   =========================== */
function stopTimerHard(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  state.timer.running = false;
  saveJSON(STORAGE_KEY, state);
}
function workoutDayKey(workoutId){ return `${todayKey}::${workoutId}`; }
function getChecksFor(workoutId){ return state.checks[workoutDayKey(workoutId)] || {}; }
function setCheck(workoutId, itemIndex, value){
  const k = workoutDayKey(workoutId);
  if(!state.checks[k]) state.checks[k] = {};
  state.checks[k][itemIndex] = value;
  saveJSON(STORAGE_KEY, state);
}
function isCheckable(ex){ return ex.type !== "section"; }
function isTimed(ex){ return typeof ex.seconds === "number" && ex.seconds > 0; }
function isRackDay(workout){
  const checkable = workout.exercises.filter(isCheckable);
  if(checkable.length === 0) return false;
  return checkable.every(ex => ex.type === "videoRef");
}
function findFirstUncheckedIndex(workout){
  const checks = getChecksFor(workout.id);
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i]) && !checks[i]) return i;
  }
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return 0;
}
function setActiveIndex(workoutId, idx){
  state.activeByKey[workoutDayKey(workoutId)] = idx;
  saveJSON(STORAGE_KEY, state);
}
function getActiveIndex(workout){
  const k = workoutDayKey(workout.id);
  const saved = state.activeByKey[k];
  if(typeof saved === "number") return saved;
  const first = findFirstUncheckedIndex(workout);
  setActiveIndex(workout.id, first);
  return first;
}
function computeCompletion(workout){
  const checks = getChecksFor(workout.id);
  const checkableIdx = workout.exercises.map((ex,i)=>({ex,i})).filter(({ex})=>isCheckable(ex)).map(({i})=>i);
  const done = checkableIdx.filter(i => !!checks[i]).length;
  const total = checkableIdx.length;
  const pct = total ? Math.round((done/total)*100) : 0;
  return { done, total, pct, allDone: total > 0 && done === total };
}
function updateProgressAndComplete(workout){
  const { done, total, pct, allDone } = computeCompletion(workout);
  $("progressText").textContent = `${done} / ${total} complete`;
  $("progressBar").style.width = `${pct}%`;
  $("workoutSubtitle").textContent = `Progress: ${pct}%`;
  $("completeHint").textContent = allDone ? "Ready to complete" : "Complete all exercises to unlock";
  $("markCompleteBtn").disabled = !allDone;
}
function scrollToItem(el){ el.scrollIntoView({ behavior: "smooth", block: "center" }); }
function renderVideos(workout){
  const sec = $("videosSection");
  sec.innerHTML = "";
  if (isRackDay(workout)) { sec.style.display = "none"; return; }
  const vids = Array.isArray(workout.videos) ? workout.videos : [];
  if(!vids.length){ sec.style.display="none"; return; }
  sec.style.display="grid";
  vids.forEach(v=>{
    const embed = toEmbedUrl(v.url);
    if(!embed) return;
    const wrap = document.createElement("div");
    wrap.innerHTML = `
      <div class="iframeBox">
        <iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>`;
    sec.appendChild(wrap);
  });
}
function findVideoForExercise(workout, exerciseLabel){
  const vids = Array.isArray(workout.videos) ? workout.videos : [];
  return vids.find(v => v.label === exerciseLabel) || vids.find(v => exerciseLabel.includes(v.label));
}

/* ===========================
   HISTORY / DASH
   =========================== */
function addHistoryEntry(workoutTitle){
  const exists = state.history.some(h => h.date === todayKey && h.title === workoutTitle);
  if(!exists){
    state.history.unshift({ date: todayKey, title: workoutTitle, ts: Date.now() });
    saveJSON(STORAGE_KEY, state);
  }
}
function computeStreak(){
  const days = new Set(state.history.map(h => h.date));
  let streak = 0;
  const d = new Date();
  while(true){
    const k = d.toISOString().slice(0,10);
    if(days.has(k)){ streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  return streak;
}
function renderHistory(){
  const list = $("historyList");
  list.innerHTML = "";
  if(state.history.length === 0){
    const it = document.createElement("div");
    it.className = "item";
    it.style.cursor = "default";
    it.innerHTML = `<div class="meta"><b>No workouts completed yet.</b></div>`;
    list.appendChild(it);
    return;
  }
  state.history.slice(0,80).forEach(h=>{
    const it = document.createElement("div");
    it.className = "item";
    it.style.cursor = "default";
    it.innerHTML = `
      <div class="meta"><b>${h.date}</b> • ${new Date(h.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
      <div class="name" style="font-style: italic;">${h.title}</div>
    `;
    list.appendChild(it);
  });
}
function renderDashboard(){
  const list = $("dashList");
  list.innerHTML = "";
  const total = state.history.length;
  const streak = computeStreak();
  const recent = state.history[0]?.date ?? "—";
  const w = WORKOUTS[currentIndex];
  const { pct } = computeCompletion(w);

  const mk = (k,v,sub="") => {
    const it = document.createElement("div");
    it.className = "item";
    it.style.cursor = "default";
    it.innerHTML = `<div class="meta"><b>${k}</b></div><div class="name" style="font-size:18px;font-weight:900;">${v}</div>${sub?`<div class="meta">${sub}</div>`:""}`;
    return it;
  };
  list.appendChild(mk("Workouts Completed (All Time)", total));
  list.appendChild(mk("Current Streak", streak, "Days in a row"));
  list.appendChild(mk("Most Recent Completion", recent));
  list.appendChild(mk("Current Workout Completion Rate", `${pct}%`));
}
function setView(view){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.view===view));
  $("view-workout").style.display = view==="workout" ? "block" : "none";
  $("view-history").style.display = view==="history" ? "block" : "none";
  $("view-dashboard").style.display = view==="dashboard" ? "block" : "none";
  if(view==="history") renderHistory();
  if(view==="dashboard") renderDashboard();
}

/* ===========================
   CELEBRATION
   =========================== */
const CELEBRATION_MESSAGES = [
  "Look at you, doing the thing. Unreasonably impressive.",
  "You showed up. That already puts you ahead of yesterday-you.",
  "Congrats. Your muscles filed a complaint and lost.",
  "Another workout completed. Main character behavior.",
  "You did it. Try not to be too powerful now."
];
function spawnConfetti(){
  const box = $("confetti");
  box.innerHTML = "";
  const n = 26;
  for(let i=0;i<n;i++){
    const p = document.createElement("i");
    p.style.left = Math.random()*100 + "%";
    p.style.animationDelay = (Math.random()*0.15) + "s";
    const colors = ["rgba(124,92,255,.9)","rgba(45,226,230,.9)","rgba(45,212,191,.9)","rgba(255,255,255,.85)"];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.width = (8 + Math.random()*6) + "px";
    p.style.height = (10 + Math.random()*8) + "px";
    box.appendChild(p);
  }
}
let celebrationTimeout = null;
function hideCelebration(){
  $("overlay").style.display = "none";
  if(celebrationTimeout) clearTimeout(celebrationTimeout);
  celebrationTimeout = null;
}
function showCelebration(){
  const msg = CELEBRATION_MESSAGES[Math.floor(Math.random()*CELEBRATION_MESSAGES.length)];
  $("celebrateMsg").textContent = msg;
  spawnConfetti();
  $("overlay").style.display = "flex";
  successChime();
  if(navigator.vibrate) navigator.vibrate([80,40,80]);

  if(celebrationTimeout) clearTimeout(celebrationTimeout);
  celebrationTimeout = setTimeout(hideCelebration, 10000);
}
$("overlay").addEventListener("click", hideCelebration);

/* ===========================
   TIMER (CUSTOMIZABLE)
   =========================== */
function readCustomSeconds(){
  const raw = ($("timerSecondsInput").value || "").trim();
  if(raw === "") return null;
  const n = parseInt(raw, 10);
  if(Number.isFinite(n) && n >= 10 && n <= 600) return n;
  return null;
}
function setInputPlaceholder(val){ $("timerSecondsInput").placeholder = String(val); }

function setGlobalTimerForActive(workout, activeIdx){
  const ex = workout.exercises[activeIdx];
  const isTimedActive = ex && isTimed(ex);
  const rack = isRackDay(workout);
  const globalTimerEl = $("globalTimer");

  if(rack || !isTimedActive){
    globalTimerEl.style.display = "none";
    if(state.timer.running) stopTimerHard();
    return;
  }

  const baseSeconds = ex.seconds;
  const needsReset =
    state.timer.workoutId !== workout.id ||
    state.timer.exerciseIndex !== activeIdx;

  if(needsReset){
    stopTimerHard();
    state.timer = {
      running:false,
      remaining: baseSeconds,
      duration: baseSeconds,
      workoutId: workout.id,
      exerciseIndex: activeIdx
    };
    $("timerSecondsInput").value = "";
    setInputPlaceholder(baseSeconds);
    saveJSON(STORAGE_KEY, state);
  } else {
    setInputPlaceholder(baseSeconds);
  }

  globalTimerEl.style.display = "block";
  $("timerBig").textContent = formatTime(state.timer.remaining);
  $("timerExerciseName").textContent = `${ex.label} • default ${formatTime(baseSeconds)}`;
  $("timerStartPause").textContent = state.timer.running ? "Pause" : "Start";
}
function applyCustomDurationIfAny(){
  const custom = readCustomSeconds();
  if(custom == null) return;
  pauseTimer();
  state.timer.duration = custom;
  state.timer.remaining = custom;
  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
  beep(660,50);
}
function tickTimer(){
  state.timer.remaining -= 1;

  if(state.timer.remaining <= 0){
    state.timer.remaining = 0;
    saveJSON(STORAGE_KEY, state);

    const workout = WORKOUTS[currentIndex];
    const idx = state.timer.exerciseIndex;

    stopTimerHard();
    flashScreen();
    toast("Timer finished ✅");
    beep(950,60);

    const checks = getChecksFor(workout.id);
    if(!checks[idx]) setCheck(workout.id, idx, true);

    const nextIdx = findFirstUncheckedIndex(workout);
    setActiveIndex(workout.id, nextIdx);

    renderWorkout();
    updateProgressAndComplete(workout);

    setTimeout(() => {
      const el = $("exerciseList").children[nextIdx];
      if(el) scrollToItem(el);
    }, 60);

    return;
  }

  if(state.timer.remaining <= 5) beep(950,35);

  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
}
function startTimer(){
  if(timerInterval) return;
  state.timer.running = true;
  saveJSON(STORAGE_KEY, state);
  $("timerStartPause").textContent = "Pause";
  beep(520,70);
  timerInterval = setInterval(tickTimer, 1000);
}
function pauseTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  state.timer.running = false;
  saveJSON(STORAGE_KEY, state);
  $("timerStartPause").textContent = "Start";
}
function resetTimer(){
  pauseTimer();
  state.timer.remaining = state.timer.duration;
  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
  beep(660,50);
}
function stopTimer(){ pauseTimer(); toast("Timer stopped"); }

/* ===========================
   RENDER
   =========================== */
function renderWorkout(){
  if(state.timer.running && !timerInterval){
    state.timer.running = false;
    saveJSON(STORAGE_KEY, state);
  }

  const workout = WORKOUTS[currentIndex];
  $("todayLabel").textContent = `Today: ${todayKey}`;
  $("cycleLabel").textContent = `${currentIndex + 1} / ${WORKOUTS.length}`;
  setSoundEnabled(soundEnabled);

  $("workoutTitle").textContent = workout.title;
  renderVideos(workout);

  const rack = isRackDay(workout);
  $("stopTimer").style.display = rack ? "none" : "inline-block";

  const list = $("exerciseList");
  list.innerHTML = "";

  const checks = getChecksFor(workout.id);
  let activeIndex = getActiveIndex(workout);

  workout.exercises.forEach((ex, idx) => {
    const item = document.createElement("div");
    item.className = "item";

    if(ex.type === "section"){
      item.classList.add("section");
      item.style.cursor = "default";
      item.innerHTML = `<div class="meta"><b>${ex.label}</b></div>`;
      list.appendChild(item);
      return;
    }

    const isActive = idx === activeIndex;
    const isChecked = !!checks[idx];

    item.classList.toggle("active", isActive);
    item.classList.toggle("collapsed", !isActive || isChecked);
    item.classList.toggle("done", isChecked);

    item.addEventListener("click", (e) => {
      if(e.target.tagName.toLowerCase() === "input") return;
      activeIndex = idx;
      setActiveIndex(workout.id, idx);
      setGlobalTimerForActive(workout, idx);
      renderWorkout();
      const el = list.children[idx];
      if(el) scrollToItem(el);
    });

    const top = document.createElement("div");
    top.className = "topline";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = isChecked;

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = ex.label;

    top.appendChild(cb);
    top.appendChild(name);
    item.appendChild(top);

    const meta = document.createElement("div");
    meta.className = "meta";
    if(ex.type === "videoRef") meta.innerHTML = `<span>Video</span>`;
    else if(ex.type === "note") meta.innerHTML = `<span>Note</span>`;
    else if(isTimed(ex)) meta.innerHTML = `<span>Timed</span><span>•</span><span>${formatTime(ex.seconds)}</span>`;
    else meta.innerHTML = `<span>Exercise</span>`;
    item.appendChild(meta);

    if (ex.type === "videoRef") {
      const vid = findVideoForExercise(workout, ex.label);
      const embed = toEmbedUrl(vid?.url || "");
      if (embed) {
        const videoWrap = document.createElement("div");
        videoWrap.innerHTML = `
          <div class="iframeBox">
            <iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
          </div>
        `;
        item.appendChild(videoWrap);
      }
    }

    cb.addEventListener("change", () => {
      setCheck(workout.id, idx, cb.checked);

      if(cb.checked){
        if(navigator.vibrate) navigator.vibrate(30);
        beep(660,60);
        const next = findFirstUncheckedIndex(workout);
        setActiveIndex(workout.id, next);
        setGlobalTimerForActive(workout, next);
      } else {
        setActiveIndex(workout.id, idx);
        setGlobalTimerForActive(workout, idx);
      }

      renderWorkout();
      updateProgressAndComplete(workout);
    });

    list.appendChild(item);
  });

  updateProgressAndComplete(workout);

  const activeIdx = getActiveIndex(workout);
  setGlobalTimerForActive(workout, activeIdx);

  setTimeout(() => {
    const el = $("exerciseList").children[activeIdx];
    if(el) el.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 40);
}

/* ===========================
   WIRING
   =========================== */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setView(t.dataset.view));
});

$("prevBtn").addEventListener("click", ()=>{
  pauseTimer();
  currentIndex = (currentIndex - 1 + WORKOUTS.length) % WORKOUTS.length;
  renderWorkout();
});
$("nextBtn").addEventListener("click", ()=>{
  pauseTimer();
  currentIndex = (currentIndex + 1) % WORKOUTS.length;
  renderWorkout();
});

$("stopTimer").addEventListener("click", ()=>{
  stopTimerHard();
  toast("Timer stopped");
  renderWorkout();
});

$("soundChip").addEventListener("click", ()=>{
  setSoundEnabled(!soundEnabled);
  toast(soundEnabled ? "Sound ON" : "Sound OFF");
});

$("timerStartPause").addEventListener("click", ()=>{
  if(!state.timer.running) applyCustomDurationIfAny();
  if(state.timer.running) pauseTimer();
  else startTimer();
  renderWorkout();
});
$("timerStop").addEventListener("click", ()=>{
  stopTimer();
  stopTimerHard();
  renderWorkout();
});
$("timerReset").addEventListener("click", ()=>{
  const custom = readCustomSeconds();
  if(custom != null){
    pauseTimer();
    state.timer.duration = custom;
    state.timer.remaining = custom;
    saveJSON(STORAGE_KEY, state);
    $("timerBig").textContent = formatTime(state.timer.remaining);
    beep(660,50);
  } else {
    resetTimer();
  }
  renderWorkout();
});

$("timerSecondsInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    applyCustomDurationIfAny();
    $("timerSecondsInput").blur();
  }
});

$("markCompleteBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const { allDone } = computeCompletion(w);
  if(!allDone){
    toast("Complete all exercises first");
    return;
  }

  addHistoryEntry(w.title);
  showCelebration();

  setTimeout(()=>{
    pauseTimer();
    currentIndex = (currentIndex + 1) % WORKOUTS.length;
    renderWorkout();
  }, 950);
});

$("clearHistory").addEventListener("click", ()=>{
  if(!confirm("Clear all workout history?")) return;
  state.history = [];
  saveJSON(STORAGE_KEY, state);
  renderHistory();
  toast("History cleared");
});

/* ===========================
   INIT (loads workouts.json first)
   =========================== */
(async function init(){
  await loadWorkoutsFromFile();

  // Ensure daily index is valid after workouts load
  if(state.lastDate !== todayKey){
    state.dayIndex = getDailyIndex(WORKOUTS.length);
    state.lastDate = todayKey;
    saveJSON(STORAGE_KEY, state);
  }
  currentIndex = state.dayIndex;

  setView("workout");
  renderWorkout();
  renderDashboard();
})();
</script>

</body>
</html>
