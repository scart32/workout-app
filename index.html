<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Workout App</title>

  <style>
    :root{
      color-scheme: dark;

      --bg0:#070812;
      --bg1:#0b0f22;

      --text:#f3f6ff;
      --muted:#a8b0c6;
      --muted2: rgba(168,176,198,.72);

      --accent:#7c5cff;
      --accent2:#2de2e6;

      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --glow: 0 0 0 3px rgba(124,92,255,.12);

      --r:16px;
      --r2:18px;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);

      /* iPhone 12 compact tuning */
      --pad:10px;
      --gap:8px;

      /* Fixed button sizing so nothing wraps */
      --btnW: 56px;     /* exercise prev/next */
      --btnWorkW: 148px;/* prev/next workout */
    }

    *{box-sizing:border-box;}
    html, body{
      height:100%;
      overflow:hidden;
      overscroll-behavior:none;
      -webkit-text-size-adjust:100%;
      touch-action: manipulation;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 900px at 15% -10%, rgba(124,92,255,.42), transparent 60%),
        radial-gradient(900px 700px at 110% 20%, rgba(45,226,230,.30), transparent 55%),
        radial-gradient(700px 600px at 50% 110%, rgba(45,212,191,.15), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      height:100dvh;
      max-width: 980px;
      margin-inline:auto;
      padding: calc(8px + var(--safeTop)) 10px calc(8px + var(--safeBottom)) 10px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: var(--gap);
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1;
      min-width:0;
    }
    .brand h1{
      margin:0;
      font-size:13px;
      font-weight:950;
      letter-spacing:.2px;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .small{
      font-size:11px;
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chips{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:nowrap;
      justify-content:flex-end;
      min-width:0;
    }
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      padding:6px 8px;
      border-radius:999px;
      font-size:11px;
      color:var(--muted);
      backdrop-filter: blur(10px);
      user-select:none;
      white-space:nowrap;
    }
    .chip strong{ color:var(--text); font-weight:950; }

    .main{
      height: calc(100dvh - var(--safeTop) - var(--safeBottom) - 16px - 40px);
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      overflow:hidden;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: var(--pad);
      overflow:hidden;
    }

    button{
      appearance:none;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 14px;
      padding:10px 10px;
      font-size:12px;
      cursor:pointer;
      font-weight:950;
      letter-spacing:.15px;
      line-height:1;
      white-space:nowrap;
      flex:0 0 auto;
    }
    button:active{transform: translateY(1px);}
    button:disabled{opacity:.40; cursor:not-allowed;}

    .btnPrimary{
      border-color: rgba(124,92,255,.60);
      background: rgba(124,92,255,.22);
      box-shadow: var(--glow);
    }
    .btnGhost{
      background: rgba(0,0,0,.12);
      border-color: rgba(255,255,255,.14);
    }
    .btnDanger{
      border-color: rgba(251,113,133,.55);
      background: rgba(251,113,133,.14);
    }

    /* ===== Workout view (NO SCROLL) ===== */
    #view-workout{
      height: 100%;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
    }

    .workoutHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .workoutHeader .left{ min-width:0; flex:1; }
    .labelTop{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.4px;
      white-space:nowrap;
    }
    #workoutTitle{
      margin:4px 0 0 0;
      font-size:14px;
      font-weight:950;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #workoutSubtitle{
      margin-top:4px;
      font-size:11px;
      color:var(--muted2);
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Progress compact */
    .progressWrap{ display:flex; flex-direction:column; gap:6px; }
    .progressMeta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:11px;
      color:var(--muted);
      font-weight:850;
      white-space:nowrap;
    }
    .bar{
      height: 9px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius:999px;
      transition: width .25s ease;
    }

    .stack{
      flex: 1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      overflow:hidden;
    }

    .activePane{
      flex: 1 1 auto;
      min-height: 0;
      border-radius: var(--r2);
      border:1px solid rgba(124,92,255,.38);
      background: rgba(0,0,0,.20);
      box-shadow: var(--glow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .paneHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-bottom:1px solid rgba(255,255,255,.08);
      white-space:nowrap;
    }
    .paneHeader b{
      font-size:11px;
      letter-spacing:.55px;
      text-transform:uppercase;
      color:rgba(168,176,198,.92);
      font-weight:950;
    }
    .paneHeader .count{
      font-size:11px;
      color:rgba(168,176,198,.82);
      font-weight:850;
    }

    .activeBody{
      flex:1 1 auto;
      min-height:0;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden; /* no scroll */
    }

    /* ===== 1-line title + buttons ALWAYS ===== */
    .activeLine{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
      min-width:0;
      white-space:nowrap;
    }
    #activeTitle{
      margin:0;
      font-size:13px;         /* shrink */
      font-weight:950;
      line-height:1.1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      flex:1 1 auto;
    }
    .exNav{
      display:flex;
      gap:8px;
      flex:0 0 auto;
      flex-wrap:nowrap;
    }
    .exNav button{
      width: var(--btnW);
      padding:10px 0;
      text-align:center;
    }

    #activeMeta{
      font-size:11px;
      color:var(--muted);
      font-weight:850;
      display:flex;
      gap:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .checkRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      user-select:none;
      cursor:pointer;
      min-width:0;
      white-space:nowrap;
    }
    .checkRow input{
      transform: scale(1.25);
      accent-color: var(--accent2);
      flex:0 0 auto;
    }
    .checkRow .label{
      font-size:12px;
      font-weight:950;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      flex:1 1 auto;
    }

    /* Video for rack exercises */
    .iframeBox{
      display:none;
      position:relative;
      width:100%;
      padding-top:50%;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:#000;
    }
    .iframeBox.show{ display:block; }
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0;}

    /* Timer (hidden for rack video exercises) */
    .timerCard{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    #timerBig{
      font-variant-numeric: tabular-nums;
      font-size: 44px;
      font-weight: 950;
      text-align:center;
      padding: 10px 10px;
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.08);
      white-space:nowrap;
    }
    .timerInner{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    #timerExerciseName{
      font-size:11px;
      color:var(--muted2);
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .timerCustomRow{
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .timerCustomRow label{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }
    #timerSecondsInput{
      flex:1;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size: 12px;
      outline:none;
      min-width:0;
    }
    .timerBtns{
      display:flex;
      gap:8px;
      width:100%;
      flex-wrap:nowrap;
      white-space:nowrap;
    }
    .timerBtns button{
      flex:1;
      padding:10px 0;
      border-radius: 14px;
      font-size:12px;
    }

    /* Next + workout nav in ONE line */
    .nextPane{
      flex:0 0 auto;
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .nextBody{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:hidden;
    }

    .nextLine{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
      min-width:0;
      white-space:nowrap;
    }
    #nextTitle{
      margin:0;
      font-size:12px; /* smaller */
      font-weight:950;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      flex:1 1 auto;
    }
    .workNav{
      display:flex;
      gap:8px;
      flex:0 0 auto;
      flex-wrap:nowrap;
    }
    .workNav button{
      width: var(--btnWorkW);
      padding:10px 0;
      text-align:center;
    }

    #nextMeta{
      font-size:11px;
      color:var(--muted);
      font-weight:850;
      display:flex;
      gap:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Footer button */
    #markCompleteBtn{
      width:100%;
      padding:12px 10px;
      font-size:13px;
      font-weight:950;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 999;
      white-space:nowrap;
    }

    .overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding:16px;
    }
    .celebrateCard{
      width: min(520px, 92vw);
      border-radius: 18px;
      padding: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .celebrateTitle{margin:0;font-size:18px;font-weight:950;}
    .celebrateMsg{margin:10px 0 0 0;color:rgba(242,244,255,.92);line-height:1.35;font-size:14px;}
    .sparkles{
      position:absolute;inset:-40px;opacity:.9;pointer-events:none;
      background:
        radial-gradient(circle at 10% 20%, rgba(124,92,255,.55), transparent 35%),
        radial-gradient(circle at 90% 30%, rgba(45,226,230,.45), transparent 40%),
        radial-gradient(circle at 50% 90%, rgba(45,212,191,.35), transparent 45%);
      filter: blur(2px);
      animation: floaty 1.4s ease-in-out infinite alternate;
    }
    @keyframes floaty{ from{ transform: translateY(0px); } to{ transform: translateY(-8px); } }
    .confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .confetti i{
      position:absolute; top:-20px;
      width:10px;height:14px;border-radius:3px;opacity:.9;
      animation: fall 1.1s linear forwards;
    }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(360deg); opacity: 1; } }

    .flash{
      position: fixed;
      inset: 0;
      z-index: 1500;
      pointer-events: none;
      background: rgba(255,255,255,.85);
      opacity: 0;
      transition: opacity .12s ease;
    }
    .flash.on{ opacity: 1; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>Elite Training Console</h1>
    <div class="small" id="todayLabel"></div>
  </div>
  <div class="chips">
    <div class="chip">Workout <strong id="cycleLabel"></strong></div>
    <div class="chip" id="soundChip" style="cursor:pointer;">Sound: <strong id="soundLabel"></strong></div>
  </div>
</header>

<div class="main">
  <section class="card" id="view-workout">

    <div class="workoutHeader">
      <div class="left">
        <div class="labelTop">WORKOUT OF THE DAY</div>
        <h2 id="workoutTitle">Loading…</h2>
        <div id="workoutSubtitle"></div>
      </div>
      <div style="display:flex; gap:6px; white-space:nowrap;">
        <div class="chip"><strong id="activeCount">—</strong></div>
      </div>
    </div>

    <div class="progressWrap">
      <div class="progressMeta">
        <div id="progressText">0 / 0</div>
        <div id="completeHint"></div>
      </div>
      <div class="bar"><div id="progressBar"></div></div>
    </div>

    <div class="stack">

      <div class="activePane">
        <div class="paneHeader">
          <b>Active</b>
          <div class="count" id="paneCount">—</div>
        </div>

        <div class="activeBody">
          <div class="activeLine">
            <p id="activeTitle">—</p>
            <div class="exNav">
              <button id="activePrevBtn" class="btnGhost">◀</button>
              <button id="activeNextBtn" class="btnGhost">▶</button>
            </div>
          </div>

          <div id="activeMeta"></div>

          <div class="checkRow" id="activeCheckRow">
            <input id="activeCheckbox" type="checkbox" />
            <div class="label" id="activeLabel">—</div>
          </div>

          <div class="iframeBox" id="activeVideoBox">
            <iframe id="activeVideoFrame"
                    src=""
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen></iframe>
          </div>

          <!-- Timer (hidden on rack video exercises) -->
          <div class="timerCard" id="timerCard">
            <div id="timerBig">60s</div>
            <div class="timerInner">
              <div id="timerExerciseName">—</div>

              <div class="timerCustomRow">
                <label for="timerSecondsInput">Secs</label>
                <input id="timerSecondsInput" inputmode="numeric" pattern="[0-9]*" placeholder="60" />
              </div>

              <div class="timerBtns">
                <button id="timerStartPause" class="btnPrimary">Start</button>
                <button id="timerStop" class="btnDanger">Stop</button>
                <button id="timerReset">Reset</button>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="nextPane">
        <div class="nextBody">
          <div class="nextLine">
            <p id="nextTitle">—</p>
            <div class="workNav">
              <button id="prevWorkoutBtn" class="btnGhost">Prev Workout</button>
              <button id="nextWorkoutBtn" class="btnGhost">Next Workout</button>
            </div>
          </div>
          <div id="nextMeta"></div>
        </div>
      </div>

      <button id="markCompleteBtn" class="btnPrimary" disabled>Mark Workout Complete</button>

    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<div class="overlay" id="overlay">
  <div class="celebrateCard">
    <div class="sparkles"></div>
    <div class="confetti" id="confetti"></div>
    <h3 class="celebrateTitle">Workout Complete ✅</h3>
    <p class="celebrateMsg" id="celebrateMsg"></p>
    <div class="small" style="margin-top:10px;color:rgba(168,176,198,.9);">Tap anywhere to dismiss.</div>
  </div>
</div>

<div class="flash" id="flash"></div>

<script>
/* ===== DATE KEY (America/Chicago) ===== */
function getLocalDateKey() {
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: "America/Chicago",
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  }).format(new Date());
}
let todayKey = getLocalDateKey();

/* ===== FALLBACK ===== */
const DEFAULT_WORKOUTS = [
  {
    id: "w1",
    title: "Workout 1 – Rack Upper (Fallback)",
    videos: [
      { label: "Rack Video #2", url: "https://www.youtube.com/watch?v=agELHJBNCuw&t=2s" },
      { label: "Rack Video #4", url: "https://www.youtube.com/watch?v=1Kj-OLK9VR0" }
    ],
    exercises: [
      { label: "Rack Video #2", type: "videoRef" },
      { label: "Rack Video #4", type: "videoRef" }
    ]
  }
];

const STORAGE_KEY = "workout_app_state_v_calendar_json1";
const SOUND_KEY   = "sound_enabled_global_v_calendar_json1";

const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  setTimeout(()=> toastEl.style.display = "none", 1500);
}
function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function toEmbedUrl(url){
  const m = url?.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{6,})/);
  return m ? `https://www.youtube.com/embed/${m[1]}` : "";
}
function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return m>0 ? `${m}:${String(s).padStart(2,"0")}` : `${sec}s`;
}
function flashScreen(){
  const f = $("flash");
  f.classList.add("on");
  setTimeout(()=>f.classList.remove("on"), 110);
  setTimeout(()=>f.classList.add("on"), 230);
  setTimeout(()=>f.classList.remove("on"), 340);
}

/* ===== SOUND ===== */
let soundEnabled = (localStorage.getItem(SOUND_KEY) ?? "true") === "true";
let audioCtx = null;
let audioUnlocked = false;
function ensureAudio(){
  if(!audioCtx){
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return null;
    audioCtx = new AudioCtx();
  }
  return audioCtx;
}
async function unlockAudio(){
  try{
    const ctx = ensureAudio();
    if(!ctx) return;
    if(ctx.state === "suspended") await ctx.resume();
    audioUnlocked = true;
  }catch{}
}
function setSoundEnabled(v){
  soundEnabled = v;
  localStorage.setItem(SOUND_KEY, v ? "true" : "false");
  $("soundLabel").textContent = v ? "On" : "Off";
}
function beep(freq=880, ms=120){
  if(!soundEnabled) return;
  const ctx = ensureAudio();
  if(!ctx || ctx.state === "suspended") return;
  try{
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine"; o.frequency.value = freq;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>o.stop(), ms);
  }catch{}
}
function successChime(){ beep(880,120); setTimeout(()=>beep(1175,140),140); }
["pointerdown","touchstart","keydown"].forEach(evt=>{
  window.addEventListener(evt, ()=>{ if(!audioUnlocked) unlockAudio(); }, { once:true, passive:true });
});
$("soundChip").addEventListener("click", async ()=>{
  await unlockAudio();
  setSoundEnabled(!soundEnabled);
  toast(soundEnabled ? "Sound ON" : "Sound OFF");
});

/* ===== LOAD workouts.json ===== */
let WORKOUTS = [];
async function loadWorkoutsFromFile(){
  try{
    const res = await fetch("./workouts.json", { cache: "no-store" });
    if(!res.ok) throw new Error("Missing workouts.json");
    const data = await res.json();
    if(!Array.isArray(data) || data.length === 0) throw new Error("Invalid workouts.json");
    WORKOUTS = data;
  }catch(err){
    console.warn("Fallback workouts:", err);
    WORKOUTS = DEFAULT_WORKOUTS;
    toast("Using fallback workouts");
  }
}

/* ===== STATE ===== */
const defaultState = {
  lastDate: "",
  currentIndex: 0,
  checks: {},
  activeByKey: {},
  timer: { running:false, remaining:0, duration:0, workoutId:"", exerciseIndex:-1 },
  timerOverrides: {}
};
let state = loadJSON(STORAGE_KEY, defaultState);
let currentIndex = 0;
let timerInterval = null;

/* ===== HELPERS ===== */
function stopTimerHard(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  state.timer.running = false;
  saveJSON(STORAGE_KEY, state);
}
function workoutDayKey(workoutId){ return `${todayKey}::${workoutId}`; }
function getChecksFor(workoutId){ return state.checks[workoutDayKey(workoutId)] || {}; }
function setCheck(workoutId, idx, v){
  const k = workoutDayKey(workoutId);
  if(!state.checks[k]) state.checks[k] = {};
  state.checks[k][idx] = v;
  saveJSON(STORAGE_KEY, state);
}
function isCheckable(ex){ return ex.type !== "section"; }
function isTimed(ex){ return typeof ex.seconds === "number" && ex.seconds > 0; }
function isRackVideo(ex){ return ex?.type === "videoRef"; }

function setActiveIndex(workoutId, idx){
  state.activeByKey[workoutDayKey(workoutId)] = idx;
  saveJSON(STORAGE_KEY, state);
}
function getActiveIndex(workout){
  const k = workoutDayKey(workout.id);
  const saved = state.activeByKey[k];
  if(typeof saved === "number") return saved;
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i])) { setActiveIndex(workout.id, i); return i; }
  }
  setActiveIndex(workout.id, 0);
  return 0;
}
function findFirstUncheckedIndex(workout){
  const checks = getChecksFor(workout.id);
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i]) && !checks[i]) return i;
  }
  for(let i=workout.exercises.length-1;i>=0;i--){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return 0;
}
function computeCompletion(workout){
  const checks = getChecksFor(workout.id);
  const checkableIdx = workout.exercises
    .map((ex,i)=>({ex,i}))
    .filter(({ex})=>isCheckable(ex))
    .map(({i})=>i);

  const done = checkableIdx.filter(i => !!checks[i]).length;
  const total = checkableIdx.length;
  const pct = total ? Math.round((done/total)*100) : 0;
  return { done, total, pct, allDone: total>0 && done===total };
}
function updateProgress(workout){
  const { done, total, pct, allDone } = computeCompletion(workout);
  $("progressText").textContent = `${done} / ${total}`;
  $("progressBar").style.width = `${pct}%`;
  $("workoutSubtitle").textContent = `Completion: ${pct}%`;
  $("completeHint").textContent = allDone ? "Ready" : "Finish all exercises";
  $("markCompleteBtn").disabled = !allDone;
}

function toMeta(ex){
  if(isRackVideo(ex)) return ["Video"];
  if(ex && isTimed(ex)) return ["Timed", formatTime(ex.seconds)];
  return ["Exercise"];
}
function findNextCheckableIndex(workout, fromIdx){
  for(let i=fromIdx+1;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return null;
}
function findPrevCheckableIndex(workout, fromIdx){
  for(let i=fromIdx-1;i>=0;i--){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return null;
}
function findVideoForExercise(workout, label){
  const vids = Array.isArray(workout.videos) ? workout.videos : [];
  return vids.find(v => v.label === label) || vids.find(v => label.includes(v.label));
}

/* ===== TIMER OVERRIDES ===== */
function ovKey(workoutId, exIdx){ return `${workoutId}::${exIdx}`; }
function getOverrideSeconds(workoutId, exIdx){
  const v = state.timerOverrides?.[ovKey(workoutId, exIdx)];
  return (Number.isFinite(v) && v>=10 && v<=600) ? v : null;
}
function setOverrideSeconds(workoutId, exIdx, seconds){
  if(!state.timerOverrides) state.timerOverrides = {};
  state.timerOverrides[ovKey(workoutId, exIdx)] = seconds;
  saveJSON(STORAGE_KEY, state);
}
function readCustomSeconds(){
  const raw = ($("timerSecondsInput").value || "").trim();
  if(raw === "") return null;
  const n = parseInt(raw, 10);
  if(Number.isFinite(n) && n>=10 && n<=600) return n;
  return null;
}
function pauseTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  state.timer.running = false;
  saveJSON(STORAGE_KEY, state);
  $("timerStartPause").textContent = "Start";
}
function resetTimerTo(seconds){
  pauseTimer();
  state.timer.duration = seconds;
  state.timer.remaining = seconds;
  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
}
function tick(){
  state.timer.remaining -= 1;
  if(state.timer.remaining < 0) state.timer.remaining = 0;
  if(state.timer.remaining === 0){
    stopTimerHard();
    flashScreen();
    beep(950,110); setTimeout(()=>beep(760,130), 140);
  }
  saveJSON(STORAGE_KEY, state);
  $("timerBig").textContent = formatTime(state.timer.remaining);
}
function startTimer(){
  if(timerInterval) return;
  const custom = readCustomSeconds();
  const w = WORKOUTS[currentIndex];
  if(custom != null){
    setOverrideSeconds(w.id, state.timer.exerciseIndex, custom);
    state.timer.duration = custom;
    state.timer.remaining = custom;
  }
  state.timer.running = true;
  saveJSON(STORAGE_KEY, state);
  $("timerStartPause").textContent = "Pause";
  beep(520,70);
  timerInterval = setInterval(tick, 1000);
}

/* ===== CELEBRATION ===== */
const CELEBRATION_MESSAGES = [
  "Good job not being a total fucking loser today.",
  "Congrats. You moved your body. The bar is low, but you cleared it.",
  "You did the workout. Try not to pass out from the responsibility.",
  "Look at you, doing hard things on purpose.",
  "Another workout completed. Shocking behavior."
];
function spawnConfetti(){
  const box = $("confetti"); box.innerHTML="";
  for(let i=0;i<22;i++){
    const p=document.createElement("i");
    p.style.left = Math.random()*100+"%";
    p.style.animationDelay = (Math.random()*0.12)+"s";
    const colors=["rgba(124,92,255,.9)","rgba(45,226,230,.9)","rgba(45,212,191,.9)","rgba(255,255,255,.85)"];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.width = (8+Math.random()*6)+"px";
    p.style.height= (10+Math.random()*8)+"px";
    box.appendChild(p);
  }
}
let celebTimeout=null;
function hideCelebration(){
  $("overlay").style.display="none";
  if(celebTimeout) clearTimeout(celebTimeout);
  celebTimeout=null;
}
function showCelebration(){
  $("celebrateMsg").textContent = CELEBRATION_MESSAGES[Math.floor(Math.random()*CELEBRATION_MESSAGES.length)];
  spawnConfetti();
  $("overlay").style.display="flex";
  successChime();
  if(celebTimeout) clearTimeout(celebTimeout);
  celebTimeout=setTimeout(hideCelebration, 10000);
}
$("overlay").addEventListener("click", hideCelebration);

/* ===== RENDER ===== */
function renderWorkout(){
  todayKey = getLocalDateKey();
  $("todayLabel").textContent = `Today: ${todayKey}`;

  if(state.lastDate !== todayKey){
    state.lastDate = todayKey;
    saveJSON(STORAGE_KEY, state);
  }

  const w = WORKOUTS[currentIndex];
  $("workoutTitle").textContent = w.title;
  $("cycleLabel").textContent = `${currentIndex+1}/${WORKOUTS.length}`;
  setSoundEnabled(soundEnabled);

  const checks = getChecksFor(w.id);

  let activeIdx = getActiveIndex(w);
  if(activeIdx < 0 || activeIdx >= w.exercises.length) activeIdx = 0;

  const firstUnchecked = findFirstUncheckedIndex(w);
  if(checks[activeIdx] && firstUnchecked !== activeIdx){
    activeIdx = firstUnchecked;
    setActiveIndex(w.id, activeIdx);
  }

  const ex = w.exercises[activeIdx];
  $("activeCount").textContent = `${activeIdx+1}/${w.exercises.length}`;
  $("paneCount").textContent = `${activeIdx+1} / ${w.exercises.length}`;

  $("activeTitle").textContent = ex?.label ?? "—";
  $("activeLabel").textContent = ex?.label ?? "—";

  const meta = $("activeMeta");
  meta.innerHTML="";
  toMeta(ex).forEach((m,i)=>{
    const s=document.createElement("span");
    s.textContent=m;
    meta.appendChild(s);
    if(i<toMeta(ex).length-1){
      const d=document.createElement("span");
      d.textContent="•"; d.style.opacity=".6";
      meta.appendChild(d);
    }
  });

  $("activeCheckbox").checked = !!checks[activeIdx];
  $("activeCheckRow").onclick = (e)=>{
    if(e.target && e.target.id==="activeCheckbox") return;
    $("activeCheckbox").checked = !$("activeCheckbox").checked;
    $("activeCheckbox").dispatchEvent(new Event("change"));
  };
  $("activeCheckbox").onchange = ()=>{
    const v = $("activeCheckbox").checked;
    setCheck(w.id, activeIdx, v);
    stopTimerHard();
    if(v){
      const next = findFirstUncheckedIndex(w);
      setActiveIndex(w.id, next);
    }else{
      setActiveIndex(w.id, activeIdx);
    }
    renderWorkout();
    updateProgress(w);
  };

  const prevIdx = findPrevCheckableIndex(w, activeIdx);
  const nextIdx = findNextCheckableIndex(w, activeIdx);
  $("activePrevBtn").disabled = prevIdx === null;
  $("activeNextBtn").disabled = nextIdx === null;

  // Video
  const vbox = $("activeVideoBox");
  const vframe = $("activeVideoFrame");
  if(isRackVideo(ex)){
    const vid = findVideoForExercise(w, ex.label);
    const embed = toEmbedUrl(vid?.url || "");
    if(embed){
      vframe.src = embed;
      vbox.classList.add("show");
    } else {
      vframe.src = "";
      vbox.classList.remove("show");
    }
  } else {
    vframe.src = "";
    vbox.classList.remove("show");
  }

  // Next exercise
  if(nextIdx === null){
    $("nextTitle").textContent = "No next exercise";
    $("nextMeta").textContent = "Finish and complete workout.";
  } else {
    const nx = w.exercises[nextIdx];
    $("nextTitle").textContent = nx.label;
    const nm = $("nextMeta");
    nm.innerHTML="";
    toMeta(nx).forEach((m,i)=>{
      const s=document.createElement("span");
      s.textContent=m;
      nm.appendChild(s);
      if(i<toMeta(nx).length-1){
        const d=document.createElement("span");
        d.textContent="•"; d.style.opacity=".6";
        nm.appendChild(d);
      }
    });
  }

  // TIMER: hidden for rack video exercises
  const timerCard = $("timerCard");
  if(isRackVideo(ex)){
    // stop timer and hide
    stopTimerHard();
    timerCard.style.display = "none";
  } else {
    timerCard.style.display = "block";

    const hasSeconds = isTimed(ex);
    const defaultSeconds = hasSeconds ? ex.seconds : 60;
    const override = getOverrideSeconds(w.id, activeIdx);
    const desired = override ?? defaultSeconds;

    const needsReset = state.timer.workoutId !== w.id || state.timer.exerciseIndex !== activeIdx;
    if(needsReset){
      stopTimerHard();
      state.timer = { running:false, remaining:desired, duration:desired, workoutId:w.id, exerciseIndex:activeIdx };
      $("timerSecondsInput").value="";
      $("timerSecondsInput").placeholder=String(desired);
      saveJSON(STORAGE_KEY, state);
    } else {
      $("timerSecondsInput").placeholder=String(desired);
    }

    $("timerBig").textContent = formatTime(state.timer.remaining);
    $("timerExerciseName").textContent = `Default ${formatTime(defaultSeconds)}${override ? " • Custom "+formatTime(override) : ""}`;
    $("timerStartPause").textContent = state.timer.running ? "Pause" : "Start";
  }

  updateProgress(w);
}

/* ===== EVENTS ===== */
$("activePrevBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const idx = getActiveIndex(w);
  const prev = findPrevCheckableIndex(w, idx);
  if(prev===null) return;
  stopTimerHard();
  setActiveIndex(w.id, prev);
  renderWorkout();
});
$("activeNextBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const idx = getActiveIndex(w);
  const next = findNextCheckableIndex(w, idx);
  if(next===null) return;
  stopTimerHard();
  setActiveIndex(w.id, next);
  renderWorkout();
});

$("prevWorkoutBtn").addEventListener("click", ()=>{
  pauseTimer();
  currentIndex = (currentIndex - 1 + WORKOUTS.length) % WORKOUTS.length;
  state.currentIndex = currentIndex;
  saveJSON(STORAGE_KEY, state);
  renderWorkout();
});
$("nextWorkoutBtn").addEventListener("click", ()=>{
  pauseTimer();
  currentIndex = (currentIndex + 1) % WORKOUTS.length;
  state.currentIndex = currentIndex;
  saveJSON(STORAGE_KEY, state);
  renderWorkout();
});

/* Timer controls */
$("timerStartPause").addEventListener("click", async ()=>{
  await unlockAudio();
  if(state.timer.running) pauseTimer();
  else startTimer();
  renderWorkout();
});
$("timerStop").addEventListener("click", ()=>{
  pauseTimer();
  stopTimerHard();
  toast("Timer stopped");
  renderWorkout();
});
$("timerReset").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const idx = state.timer.exerciseIndex;
  const custom = readCustomSeconds();
  if(custom != null){
    setOverrideSeconds(w.id, idx, custom);
    resetTimerTo(custom);
    beep(660,50);
  } else {
    const ex = w.exercises[idx];
    const def = isTimed(ex) ? ex.seconds : 60;
    const ov = getOverrideSeconds(w.id, idx);
    resetTimerTo(ov ?? def);
  }
  renderWorkout();
});
$("timerSecondsInput").addEventListener("blur", ()=>{
  const custom = readCustomSeconds();
  if(custom != null){
    const w = WORKOUTS[currentIndex];
    setOverrideSeconds(w.id, state.timer.exerciseIndex, custom);
    if(!state.timer.running) resetTimerTo(custom);
    toast("Custom saved");
  }
});

/* Mark complete */
$("markCompleteBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const { allDone } = computeCompletion(w);
  if(!allDone){ toast("Finish all exercises"); return; }
  showCelebration();

  setTimeout(()=>{
    pauseTimer();
    currentIndex = (currentIndex + 1) % WORKOUTS.length;
    state.currentIndex = currentIndex;
    saveJSON(STORAGE_KEY, state);
    renderWorkout();
  }, 950);
});

/* INIT */
(async function init(){
  await loadWorkoutsFromFile();

  state = { ...defaultState, ...state };
  if(!state.timerOverrides) state.timerOverrides = {};

  todayKey = getLocalDateKey();
  if(state.lastDate !== todayKey){
    state.lastDate = todayKey;
    saveJSON(STORAGE_KEY, state);
  }

  if (typeof state.currentIndex !== "number") state.currentIndex = 0;
  if (state.currentIndex < 0 || state.currentIndex >= WORKOUTS.length) state.currentIndex = 0;
  currentIndex = state.currentIndex;

  setSoundEnabled(soundEnabled);
  renderWorkout();
})();
</script>
</body>
</html>
