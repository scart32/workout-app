<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workout App</title>
  <style>
    :root{
      color-scheme: dark;
      --bg0:#0a0b10;
      --bg1:#0f1220;
      --text:#f2f4ff;
      --muted:#a8b0c6;
      --accent:#7c5cff;
      --accent2:#2de2e6;
      --good:#2dd4bf;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
                  radial-gradient(900px 700px at 110% 20%, rgba(45,226,230,.25), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      padding:16px;
      max-width: 920px;
      margin-inline:auto;
    }
    header{display:flex;flex-direction:column;gap:12px;margin-bottom:14px;}
    .topbar{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    h1{margin:0;font-size:20px;letter-spacing:.2px;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
    }
    .chip strong{color:var(--text);font-weight:600;}

    .nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);cursor:pointer;font-size:13px;
    }
    .tab.active{
      border-color: rgba(124,92,255,.7);
      box-shadow: 0 0 0 3px rgba(124,92,255,.15);
      background: rgba(124,92,255,.18);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .row{display:flex;gap:12px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;}
    .titleBlock{display:flex;flex-direction:column;gap:6px;min-width: 260px;}
    h2{margin:0;font-size:16px;}
    .small{font-size:12px;color:var(--muted);}

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    button:hover{background: rgba(255,255,255,.10);}
    button:active{transform: translateY(1px);}
    button:disabled{opacity:.45; cursor:not-allowed;}
    .btnPrimary{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.22);
    }
    .btnGhost{background: transparent;border-color: rgba(255,255,255,.14);}
    .btnDanger{border-color: rgba(251,113,133,.55);background: rgba(251,113,133,.15);}

    .progressWrap{margin-top:12px;display:flex;flex-direction:column;gap:8px;}
    .progressMeta{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;}
    .bar{height: 10px;border-radius: 999px;background: rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden;}
    .bar > div{height:100%;width:0%;background: linear-gradient(90deg, var(--accent), var(--accent2));border-radius: 999px;transition: width .25s ease;}

    .videosGrid{display:grid;grid-template-columns: 1fr;gap:12px;margin-top:14px;}
    @media (min-width: 820px){.videosGrid{grid-template-columns: 1fr 1fr;}}
    .videoTitle{margin:0 0 8px 0;color:var(--muted);font-size:12px;}
    .iframeBox{position:relative;width:100%;padding-top:56.25%;border-radius: 14px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:#000;}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0;}

    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px;}
    .item{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition: border-color .15s ease, background .15s ease, transform .05s ease, opacity .15s ease;
      cursor: pointer;
    }
    .item:active{transform: translateY(1px);}
    .item.active{
      border-color: rgba(45,212,191,.8);
      box-shadow: 0 0 0 3px rgba(45,212,191,.15);
      opacity: 1;
    }
    .item.section{
      cursor: default;
      background: rgba(255,255,255,.05);
      border-style: dashed;
      opacity: 1;
    }
    .topline{display:flex;gap:10px;align-items:flex-start;}
    .topline input{transform: scale(1.35);margin-top:2px;accent-color: var(--accent2);}
    .name{font-size:13.5px;line-height:1.25;flex:1;}
    .done .name{text-decoration: line-through;color: rgba(168,176,198,.75);}

    .collapsed .meta, .collapsed .timerRow { display:none; }
    .collapsed{opacity:.72;}

    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color: var(--muted);font-size: 12px;}
    .timerRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .timeBox{
      font-variant-numeric: tabular-nums;
      padding: 7px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      min-width: 92px;
      text-align:center;
      font-size: 13px;
    }
    .pillBtn{padding: 8px 10px;border-radius: 999px;font-size: 12px;}

    .divider{height:1px;background: rgba(255,255,255,.10);margin: 14px 0;}
    .toast{
      position: fixed;left: 50%;transform: translateX(-50%);
      bottom: 18px;background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      padding: 10px 12px;border-radius: 999px;
      font-size: 12px;color: var(--text);
      backdrop-filter: blur(10px);
      display:none;z-index: 999;
    }

    textarea{
      width:100%;min-height: 260px;border-radius: 14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      line-height: 1.35;
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.35;}
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <div>
      <h1>Workout App</h1>
    </div>
    <div class="chips">
      <div class="chip"><strong id="todayLabel"></strong></div>
      <div class="chip">Cycle: <strong id="cycleLabel"></strong></div>
      <div class="chip">Sound: <strong id="soundLabel"></strong></div>
    </div>
  </div>

  <div class="nav">
    <button class="tab active" data-view="workout">Workout</button>
    <button class="tab" data-view="history">History</button>
    <button class="tab" data-view="dashboard">Dashboard</button>
    <button class="tab" data-view="builder">Month Builder</button>
  </div>
</header>

<!-- WORKOUT VIEW -->
<section class="card" id="view-workout">
  <div class="row">
    <div class="titleBlock">
      <h2 id="workoutTitle">Loading…</h2>
      <div class="small" id="workoutSubtitle"></div>
    </div>

    <div class="row" style="gap:8px;justify-content:flex-end;" id="topControls">
      <button id="prevBtn" class="btnGhost">Previous</button>
      <button id="nextBtn" class="btnGhost">Next</button>
      <button id="stopTimer" class="btnDanger">Stop Timer</button>
      <button id="toggleSound" class="btnGhost">Toggle Sound</button>
    </div>
  </div>

  <div class="progressWrap">
    <div class="progressMeta">
      <div id="progressText">0 / 0 complete</div>
      <div class="small" id="completeHint"></div>
    </div>
    <div class="bar"><div id="progressBar"></div></div>
  </div>

  <div id="videosSection" class="videosGrid" style="display:none;"></div>
  <div class="list" id="exerciseList"></div>

  <!-- Button at bottom; only enabled when all checkable exercises are completed -->
  <div class="divider"></div>
  <button id="markCompleteBtn" class="btnPrimary" style="width:100%;" disabled>
    Mark Workout Complete
  </button>
</section>

<!-- HISTORY VIEW -->
<section class="card" id="view-history" style="display:none;">
  <div class="row">
    <div class="titleBlock">
      <h2>Workout Completion History</h2>
      <div class="small">Completed workouts are logged here.</div>
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end;">
      <button id="clearHistory" class="btnDanger">Clear History</button>
    </div>
  </div>
  <div class="divider"></div>
  <div id="historyList" class="list"></div>
</section>

<!-- DASHBOARD VIEW -->
<section class="card" id="view-dashboard" style="display:none;">
  <div class="row">
    <div class="titleBlock">
      <h2>Performance Dashboard</h2>
      <div class="small">High-level stats.</div>
    </div>
  </div>
  <div class="divider"></div>
  <div class="list" id="dashList"></div>
</section>

<!-- BUILDER VIEW -->
<section class="card" id="view-builder" style="display:none;">
  <div class="row">
    <div class="titleBlock">
      <h2>Custom Month Builder</h2>
      <div class="small">Edit workouts in JSON. Save month instantly.</div>
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end;">
      <button id="loadDefault" class="btnGhost">Load Default</button>
      <button id="loadCurrent" class="btnGhost">Load Current</button>
      <button id="saveBuilder" class="btnPrimary">Save Month</button>
      <button id="exportMonth" class="btnGhost">Export JSON</button>
    </div>
  </div>
  <div class="divider"></div>
  <div class="hint">
    Timed sets: <code>{"label":"Back Squat","seconds":60}</code> • Zone headers: <code>{"label":"Zone 1","type":"section"}</code> • Notes: <code>{"type":"note"}</code> • Videos: <code>videos:[{label,url}]</code>
  </div>
  <textarea id="builderText"></textarea>
</section>

<div class="toast" id="toast"></div>

<script>
/* ===== DEFAULT MONTH ===== */
const DEFAULT_WORKOUTS = [
  {
    id: "w1",
    title: "Workout 1 – Rack Upper",
    videos: [
      { label: "Rack Video #2", url: "https://www.youtube.com/watch?v=agELHJBNCuw&t=2s" },
      { label: "Rack Video #4", url: "https://www.youtube.com/watch?v=1Kj-OLK9VR0" }
    ],
    exercises: [
      { label: "Rack Video #2", type: "videoRef" },
      { label: "Rack Video #4", type: "videoRef" }
    ]
  },
  {
    id: "w2",
    title: "Workout 2 – 30 Min Leg Power Builder",
    exercises: [
      { label: "Zone 1 (60 sec)", type: "section" },
      { label: "Back Squat", seconds: 60 },
      { label: "Romanian Deadlift", seconds: 60 },
      { label: "Front Squat", seconds: 60 },
      { label: "Zone 2 (50–60 sec)", type: "section" },
      { label: "Walking DB Lunges", seconds: 60 },
      { label: "Barbell Step-Ups", seconds: 60 },
      { label: "Kettlebell Swings", seconds: 60 },
      { label: "Zone 3 (45–60 sec)", type: "section" },
      { label: "Bulgarian Split Squat (R)", seconds: 60 },
      { label: "Bulgarian Split Squat (L)", seconds: 60 },
      { label: "Heels-Elevated DB Squat", seconds: 60 },
      { label: "Finish", type: "section" },
      { label: "Barbell Bench Press – 4–5 sets", type: "note" }
    ]
  },
  {
    id: "w3",
    title: "Workout 3 – Rack Hybrid",
    videos: [
      { label: "Rack Video #3", url: "https://www.youtube.com/watch?v=xh6ZgnyZrh8" }
    ],
    exercises: [
      { label: "Rack Video #3", type: "videoRef" }
    ]
  },
  {
    id: "w4",
    title: "Workout 4 – 30 Min Athletic Leg Conditioning",
    exercises: [
      { label: "Zone 1 (60 sec)", type: "section" },
      { label: "Deadlift", seconds: 60 },
      { label: "Front Squat", seconds: 60 },
      { label: "Tempo Back Squat", seconds: 60 },
      { label: "Zone 2 (50–60 sec)", type: "section" },
      { label: "Reverse Lunges", seconds: 60 },
      { label: "Single-Leg DB RDL", seconds: 60 },
      { label: "KB Front Rack Squats", seconds: 60 },
      { label: "Zone 3 (45–60 sec)", type: "section" },
      { label: "Lateral Lunges", seconds: 60 },
      { label: "DB Squat to Press", seconds: 60 },
      { label: "Broad Jump → Reset", seconds: 60 }
    ]
  },
  {
    id: "w5",
    title: "Workout 5 – Rack Upper",
    videos: [
      { label: "Rack Video #2", url: "https://www.youtube.com/watch?v=agELHJBNCuw&t=2s" },
      { label: "Rack Video #4", url: "https://www.youtube.com/watch?v=1Kj-OLK9VR0" }
    ],
    exercises: [
      { label: "Rack Video #2", type: "videoRef" },
      { label: "Rack Video #4", type: "videoRef" }
    ]
  },
  {
    id: "w6",
    title: "Workout 6 – 30 Min Strength Bias Leg Day",
    exercises: [
      { label: "Zone 1 (60 sec)", type: "section" },
      { label: "Back Squat", seconds: 60 },
      { label: "Romanian Deadlift", seconds: 60 },
      { label: "Narrow Stance Barbell Squat", seconds: 60 },
      { label: "Zone 2 (50–60 sec)", type: "section" },
      { label: "Elevated Split Squat (R)", seconds: 60 },
      { label: "Elevated Split Squat (L)", seconds: 60 },
      { label: "Hip Thrust", seconds: 60 },
      { label: "Zone 3 (45–60 sec)", type: "section" },
      { label: "Kettlebell Swings", seconds: 60 },
      { label: "Step-Back Lunges", seconds: 60 },
      { label: "Heels-Elevated DB Squat Pulses", seconds: 60 },
      { label: "Finish", type: "section" },
      { label: "Barbell Bench Press – 5 sets", type: "note" }
    ]
  },
  {
    id: "w7",
    title: "Workout 7 – Rack Hybrid",
    videos: [
      { label: "Rack Video #3", url: "https://www.youtube.com/watch?v=xh6ZgnyZrh8" }
    ],
    exercises: [
      { label: "Rack Video #3", type: "videoRef" }
    ]
  },
  {
    id: "w8",
    title: "Workout 8 – 30 Min Leg Endurance Finisher",
    exercises: [
      { label: "Zone 1 (60 sec)", type: "section" },
      { label: "Deadlift", seconds: 60 },
      { label: "Front Squat", seconds: 60 },
      { label: "Tempo Back Squat", seconds: 60 },
      { label: "Zone 2 (50–60 sec)", type: "section" },
      { label: "Walking Lunges", seconds: 60 },
      { label: "Barbell Step-Ups", seconds: 60 },
      { label: "Single-Leg DB RDL", seconds: 60 },
      { label: "Zone 3 (45–60 sec)", type: "section" },
      { label: "KB Swings", seconds: 60 },
      { label: "Narrow Stance Squat", seconds: 60 },
      { label: "Lateral DB Lunges", seconds: 60 }
    ]
  }
];

/* ===== storage + helpers ===== */
const STORAGE_KEY = "workout_app_active_v2";
const MONTH_KEY = "workouts_custom_month_v3";
const SOUND_KEY = "sound_enabled_v3";
const todayKey = new Date().toISOString().slice(0,10);

const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  setTimeout(()=> toastEl.style.display = "none", 1600);
}

function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function toEmbedUrl(url){
  if(!url) return "";
  const m = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{6,})/);
  if(!m) return "";
  return `https://www.youtube.com/embed/${m[1]}`;
}
function getDailyIndex(len){
  const epochDays = Math.floor(Date.now() / (1000*60*60*24));
  return epochDays % len;
}
function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return m>0 ? `${m}:${String(s).padStart(2,"0")}` : `${sec}s`;
}

/* ===== sound ===== */
let soundEnabled = (localStorage.getItem(SOUND_KEY) ?? "true") === "true";
function setSoundEnabled(v){
  soundEnabled = v;
  localStorage.setItem(SOUND_KEY, v ? "true" : "false");
  $("soundLabel").textContent = v ? "On" : "Off";
}
function beep(freq=880, ms=120){
  if(!soundEnabled) return;
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine"; o.frequency.value = freq;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, ms);
  }catch{}
}
function successChime(){
  beep(880,120); setTimeout(()=>beep(1175,140),140);
}

/* ===== month + state ===== */
let WORKOUTS = loadJSON(MONTH_KEY, null);
if(!Array.isArray(WORKOUTS) || WORKOUTS.length === 0){
  WORKOUTS = DEFAULT_WORKOUTS;
  saveJSON(MONTH_KEY, WORKOUTS);
}

const defaultState = { lastDate:"", dayIndex:0, checks:{}, history:[], activeByKey:{} };
let state = loadJSON(STORAGE_KEY, defaultState);

// daily sync
if(state.lastDate !== todayKey){
  state.dayIndex = getDailyIndex(WORKOUTS.length);
  state.lastDate = todayKey;
  saveJSON(STORAGE_KEY, state);
}

let currentIndex = state.dayIndex;
let activeTimer = null;

function stopActiveTimer(){
  if(activeTimer?.interval) clearInterval(activeTimer.interval);
  activeTimer = null;
}

function workoutDayKey(workoutId){ return `${todayKey}::${workoutId}`; }
function getChecksFor(workoutId){ return state.checks[workoutDayKey(workoutId)] || {}; }
function setCheck(workoutId, itemIndex, value){
  const k = workoutDayKey(workoutId);
  if(!state.checks[k]) state.checks[k] = {};
  state.checks[k][itemIndex] = value;
  saveJSON(STORAGE_KEY, state);
}

function isCheckable(ex){ return ex.type !== "section"; }
function isTimed(ex){ return typeof ex.seconds === "number" && ex.seconds > 0; }

// Rack day definition: ONLY checkable items are videoRef (no timed sets)
function isRackDay(workout){
  const checkable = workout.exercises.filter(isCheckable);
  if(checkable.length === 0) return false;
  return checkable.every(ex => ex.type === "videoRef");
}

function findFirstUncheckedIndex(workout){
  const checks = getChecksFor(workout.id);
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i]) && !checks[i]) return i;
  }
  for(let i=0;i<workout.exercises.length;i++){
    if(isCheckable(workout.exercises[i])) return i;
  }
  return 0;
}

function setActiveIndex(workoutId, idx){
  state.activeByKey[workoutDayKey(workoutId)] = idx;
  saveJSON(STORAGE_KEY, state);
}
function getActiveIndex(workout){
  const k = workoutDayKey(workout.id);
  const saved = state.activeByKey[k];
  if(typeof saved === "number") return saved;
  const first = findFirstUncheckedIndex(workout);
  setActiveIndex(workout.id, first);
  return first;
}

function computeCompletion(workout){
  const checks = getChecksFor(workout.id);
  const checkableIdx = workout.exercises.map((ex,i)=>({ex,i})).filter(({ex})=>isCheckable(ex)).map(({i})=>i);
  const done = checkableIdx.filter(i => !!checks[i]).length;
  const total = checkableIdx.length;
  const pct = total ? Math.round((done/total)*100) : 0;
  return { done, total, pct, allDone: total > 0 && done === total };
}

function updateProgressAndComplete(workout){
  const { done, total, pct, allDone } = computeCompletion(workout);
  $("progressText").textContent = `${done} / ${total} complete`;
  $("progressBar").style.width = `${pct}%`;
  $("workoutSubtitle").textContent = `Progress: ${pct}%`;
  $("completeHint").textContent = allDone ? "Ready to complete" : "Complete all exercises to unlock";

  const btn = $("markCompleteBtn");
  btn.disabled = !allDone;
}

function scrollToItem(el){
  el.scrollIntoView({ behavior: "smooth", block: "center" });
}

function renderVideos(workout){
  const sec = $("videosSection");
  sec.innerHTML = "";
  const vids = Array.isArray(workout.videos) ? workout.videos : [];
  if(!vids.length){ sec.style.display="none"; return; }
  sec.style.display="grid";
  vids.forEach(v=>{
    const embed = toEmbedUrl(v.url);
    if(!embed) return;
    const wrap = document.createElement("div");
    wrap.innerHTML = `
      <p class="videoTitle">${v.label}</p>
      <div class="iframeBox">
        <iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>`;
    sec.appendChild(wrap);
  });
}

/* ===== history + dashboard ===== */
function addHistoryEntry(workoutTitle){
  const exists = state.history.some(h => h.date === todayKey && h.title === workoutTitle);
  if(!exists){
    state.history.unshift({ date: todayKey, title: workoutTitle, ts: Date.now() });
    saveJSON(STORAGE_KEY, state);
  }
}
function computeStreak(){
  const days = new Set(state.history.map(h => h.date));
  let streak = 0;
  const d = new Date();
  while(true){
    const k = d.toISOString().slice(0,10);
    if(days.has(k)){ streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  return streak;
}
function renderHistory(){
  const list = $("historyList");
  list.innerHTML = "";
  if(state.history.length === 0){
    const it = document.createElement("div");
    it.className = "item";
    it.innerHTML = `<div class="meta"><b>No workouts completed yet.</b></div>`;
    list.appendChild(it);
    return;
  }
  state.history.slice(0,80).forEach(h=>{
    const it = document.createElement("div");
    it.className = "item";
    it.innerHTML = `<div class="meta"><b>${h.date}</b> • ${new Date(h.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div><div class="name">${h.title}</div>`;
    list.appendChild(it);
  });
}
function renderDashboard(){
  const list = $("dashList");
  list.innerHTML = "";

  const total = state.history.length;
  const streak = computeStreak();
  const recent = state.history[0]?.date ?? "—";

  const w = WORKOUTS[currentIndex];
  const { pct } = computeCompletion(w);

  const mk = (k,v,sub="") => {
    const it = document.createElement("div");
    it.className = "item";
    it.style.cursor = "default";
    it.innerHTML = `<div class="meta"><b>${k}</b></div><div class="name" style="font-size:18px;font-weight:800;">${v}</div>${sub?`<div class="meta">${sub}</div>`:""}`;
    return it;
  };

  list.appendChild(mk("Workouts Completed (All Time)", total));
  list.appendChild(mk("Current Streak", streak, "Days in a row"));
  list.appendChild(mk("Most Recent Completion", recent));
  list.appendChild(mk("Current Workout Completion Rate", `${pct}%`));
}

/* ===== views ===== */
function setView(view){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.view===view));
  $("view-workout").style.display = view==="workout" ? "block" : "none";
  $("view-history").style.display = view==="history" ? "block" : "none";
  $("view-dashboard").style.display = view==="dashboard" ? "block" : "none";
  $("view-builder").style.display = view==="builder" ? "block" : "none";

  if(view==="history") renderHistory();
  if(view==="dashboard") renderDashboard();
  if(view==="builder") $("builderText").value = JSON.stringify(WORKOUTS, null, 2);
}

/* ===== builder ===== */
function saveBuilder(){
  try{
    const parsed = JSON.parse($("builderText").value);
    if(!Array.isArray(parsed) || parsed.length === 0) throw new Error("Must be a non-empty array");
    parsed.forEach((w,i)=>{
      if(!w.id) w.id = `w${i+1}`;
      if(!w.title) throw new Error("Every workout needs a title");
      if(!Array.isArray(w.exercises)) throw new Error("Every workout needs exercises array");
    });
    WORKOUTS = parsed;
    saveJSON(MONTH_KEY, WORKOUTS);

    currentIndex = getDailyIndex(WORKOUTS.length);
    state.dayIndex = currentIndex;
    saveJSON(STORAGE_KEY, state);

    toast("Month saved");
    setView("workout");
    renderWorkout();
  }catch(e){
    toast("JSON error: " + e.message);
  }
}

/* ===== main render ===== */
function renderWorkout(){
  stopActiveTimer();

  const workout = WORKOUTS[currentIndex];

  $("todayLabel").textContent = `Today: ${todayKey}`;
  $("cycleLabel").textContent = `${currentIndex + 1} / ${WORKOUTS.length}`;
  setSoundEnabled(soundEnabled);

  $("workoutTitle").textContent = workout.title;
  renderVideos(workout);

  // Hide stop timer + toggle sound for rack days
  const rack = isRackDay(workout);
  $("stopTimer").style.display = rack ? "none" : "inline-block";
  $("toggleSound").style.display = rack ? "none" : "inline-block";

  const list = $("exerciseList");
  list.innerHTML = "";

  const checks = getChecksFor(workout.id);
  let activeIndex = getActiveIndex(workout);

  workout.exercises.forEach((ex, idx) => {
    const item = document.createElement("div");
    item.className = "item";

    if(ex.type === "section"){
      item.classList.add("section");
      item.style.cursor = "default";
      item.innerHTML = `<div class="meta"><b>${ex.label}</b></div>`;
      list.appendChild(item);
      return;
    }

    const isActive = idx === activeIndex;
    const isChecked = !!checks[idx];

    item.classList.toggle("active", isActive);
    item.classList.toggle("collapsed", !isActive || isChecked);
    item.classList.toggle("done", isChecked);

    item.addEventListener("click", (e) => {
      if(e.target.tagName.toLowerCase() === "button" || e.target.tagName.toLowerCase() === "input") return;
      activeIndex = idx;
      setActiveIndex(workout.id, idx);
      renderWorkout();
      const el = list.children[idx];
      if(el) scrollToItem(el);
    });

    const top = document.createElement("div");
    top.className = "topline";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = isChecked;

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = ex.label;

    top.appendChild(cb);
    top.appendChild(name);
    item.appendChild(top);

    const meta = document.createElement("div");
    meta.className = "meta";
    if(ex.type === "videoRef") meta.innerHTML = `<span>Video</span>`;
    else if(ex.type === "note") meta.innerHTML = `<span>Note</span>`;
    else if(isTimed(ex)) meta.innerHTML = `<span>Timed</span><span>•</span><span>${formatTime(ex.seconds)}</span>`;
    else meta.innerHTML = `<span>Exercise</span>`;
    item.appendChild(meta);

    cb.addEventListener("change", () => {
      setCheck(workout.id, idx, cb.checked);

      if(cb.checked){
        if(navigator.vibrate) navigator.vibrate(35);
        beep(660,70);
        const next = findFirstUncheckedIndex(workout);
        setActiveIndex(workout.id, next);
      } else {
        setActiveIndex(workout.id, idx);
      }

      renderWorkout();
      updateProgressAndComplete(workout);
    });

    if(isTimed(ex)){
      const timerRow = document.createElement("div");
      timerRow.className = "timerRow";

      const timeBox = document.createElement("div");
      timeBox.className = "timeBox";

      let remaining = ex.seconds;
      const updateBox = () => timeBox.textContent = formatTime(remaining);
      updateBox();

      const startBtn = document.createElement("button");
      startBtn.className = "pillBtn btnPrimary";
      startBtn.textContent = "Start";

      const resetBtn = document.createElement("button");
      resetBtn.className = "pillBtn";
      resetBtn.textContent = "Reset";

      const stopBtn = document.createElement("button");
      stopBtn.className = "pillBtn btnDanger";
      stopBtn.textContent = "Stop";

      startBtn.addEventListener("click", () => {
        stopActiveTimer();
        if(remaining <= 0) remaining = ex.seconds;
        updateBox();
        beep(520,70);

        activeTimer = {
          interval: setInterval(() => {
            remaining -= 1;
            if(remaining <= 0){
              remaining = 0;
              updateBox();
              clearInterval(activeTimer.interval);
              activeTimer = null;

              // auto-check
              if(!cb.checked){
                cb.checked = true;
                setCheck(workout.id, idx, true);
              }

              successChime();
              if(navigator.vibrate) navigator.vibrate([200,100,200]);

              const nextIdx = findFirstUncheckedIndex(workout);
              setActiveIndex(workout.id, nextIdx);

              renderWorkout();
              updateProgressAndComplete(workout);

              setTimeout(() => {
                const newActive = list.children[nextIdx];
                if(newActive) scrollToItem(newActive);
              }, 50);

            } else {
              if(remaining <= 5) beep(950,35);
              updateBox();
            }
          }, 1000)
        };
      });

      resetBtn.addEventListener("click", () => { remaining = ex.seconds; updateBox(); });
      stopBtn.addEventListener("click", () => { stopActiveTimer(); });

      timerRow.appendChild(timeBox);
      timerRow.appendChild(startBtn);
      timerRow.appendChild(resetBtn);
      timerRow.appendChild(stopBtn);
      item.appendChild(timerRow);
    }

    list.appendChild(item);
  });

  // Ensure rack upper days: separate checkbox entries for video #2 and #4
  // (already in data, this just prevents accidental merging later)
  updateProgressAndComplete(workout);

  // scroll active into view
  setTimeout(() => {
    const activeIdx = getActiveIndex(workout);
    const el = $("exerciseList").children[activeIdx];
    if(el) el.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 60);
}

/* ===== wiring ===== */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setView(t.dataset.view));
});

$("prevBtn").addEventListener("click", ()=>{
  currentIndex = (currentIndex - 1 + WORKOUTS.length) % WORKOUTS.length;
  renderWorkout();
});
$("nextBtn").addEventListener("click", ()=>{
  currentIndex = (currentIndex + 1) % WORKOUTS.length;
  renderWorkout();
});

$("stopTimer").addEventListener("click", ()=>{
  stopActiveTimer();
  toast("Timer stopped");
});

$("toggleSound").addEventListener("click", ()=>{
  setSoundEnabled(!soundEnabled);
  toast(soundEnabled ? "Sound ON" : "Sound OFF");
});

$("markCompleteBtn").addEventListener("click", ()=>{
  const w = WORKOUTS[currentIndex];
  const { allDone } = computeCompletion(w);
  if(!allDone){
    toast("Complete all exercises first");
    return;
  }
  addHistoryEntry(w.title);
  toast("Workout logged ✅");
  successChime();
});

$("clearHistory").addEventListener("click", ()=>{
  if(!confirm("Clear all workout history?")) return;
  state.history = [];
  saveJSON(STORAGE_KEY, state);
  renderHistory();
  toast("History cleared");
});

$("loadDefault").addEventListener("click", ()=>{
  $("builderText").value = JSON.stringify(DEFAULT_WORKOUTS, null, 2);
});
$("loadCurrent").addEventListener("click", ()=>{
  $("builderText").value = JSON.stringify(WORKOUTS, null, 2);
});
$("saveBuilder").addEventListener("click", saveBuilder);
$("exportMonth").addEventListener("click", ()=>{
  navigator.clipboard?.writeText(JSON.stringify(WORKOUTS, null, 2));
  toast("Copied JSON to clipboard");
});

// initial
setView("workout");
renderWorkout();
renderDashboard();
</script>

</body>
</html>
